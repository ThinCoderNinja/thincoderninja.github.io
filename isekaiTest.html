<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YDIARWBWRBTGOLAJTHAWYBA - Simulator v8 (Advanced)</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1a202c; color: #e2e8f0; }
        .game-container { max-width: 1100px; margin: 0.5rem auto; padding: 1rem; background-color: #2d3748; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .btn { padding: 0.5rem 0.8rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.2s ease-in-out; cursor: pointer; border: none; font-size: 0.8rem; }
        .btn-primary { background-color: #4a5568; color: #e2e8f0; }
        .btn-primary:hover { background-color: #2c5282; }
        .btn-action, .btn-romance, .btn-world, .btn-age-specific { background-color: #38a169; color: white; }
        .btn-action:hover, .btn-romance:hover, .btn-world:hover, .btn-age-specific:hover { background-color: #2f855a; }
        .btn-world { background-color: #d69e2e; } 
        .btn-world:hover { background-color: #b08026; }
        .btn-danger { background-color: #c53030; color: white; }
        .btn-danger:hover { background-color: #9b2c2c; }
        .btn-info { background-color: #3182ce; color: white; }
        .btn-info:hover { background-color: #2b6cb0; }
        .btn-battle { background-color: #97266d; color: white; }
        .btn-battle:hover { background-color: #702459; }
        .btn-dungeon { background-color: #dd6b20; color: white; } 
        .btn-dungeon:hover { background-color: #c05621; }
        .btn-save { background-color: #b7791f; color: white; } 
        .btn-save:hover { background-color: #975a16; }
        .btn-bag { background-color: #63b3ed; color: white; } 
        .btn-bag:hover { background-color: #4299e1; }
        .btn-tavern { background-color: #a0aec0; color: #1a202c; }
        .btn-tavern:hover { background-color: #718096; }
        .btn-shop { background-color: #ecc94b; color: #1a202c; }
        .btn-shop:hover { background-color: #d69e2e; }
        .btn-confess { background-color: #d53f8c; color: white; } 
        .btn-confess:hover { background-color: #b83280; }
        .btn-sell { background-color: #e53e3e; color: white; }
        .btn-sell:hover { background-color: #c53030; }
        .btn-manage-social { background-color: #4299e1; color:white;}
        .btn-manage-social:hover { background-color: #2b6cb0;}
        .btn-deaths { background-color: #718096; color: white; }
        .btn-deaths:hover { background-color: #4a5568;}
        .btn-guild { background-color: #6b46c1; color: white;}
        .btn-guild:hover { background-color: #553c9a;}


        .character-sheet div, .log-entry { padding: 0.15rem 0.3rem; border-bottom: 1px solid #4a5568; font-size: 0.78rem; }
        .character-sheet div:last-child, .log-entry:last-child { border-bottom: none; }
        .title-font { font-family: 'MedievalSharp', cursive; }
        .game-title-header { font-size: 1.1rem; line-height: 1.2; }
        @media (min-width: 640px) { .game-title-header { font-size: 1.3rem; } }
        @media (min-width: 1024px) { .game-title-header { font-size: 1.5rem; } }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 100; padding: 1rem; }
        .modal-content { background-color: #2d3748; padding: 1.5rem; border-radius: 0.5rem; text-align: center; max-width: 90%; width: 500px; border: 2px solid #4a5568; } 
        .hidden { display: none !important; }
        .action-button-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(190px, 1fr)); gap: 0.3rem; }
        .progress-bar-container { width: 100%; background-color: #4a5568; border-radius: 0.25rem; overflow: hidden; height: 0.8rem; margin-top: 0.15rem; }
        .progress-bar { height: 100%; text-align: center; line-height: 0.8rem; color: white; font-size: 0.65rem; transition: width 0.3s ease-in-out; }
        .hp-bar { background-color: #c53030; } 
        .xp-bar { background-color: #3182ce; } 
        .power-bar { background-color: #f6e05e; color: #1a202c !important; } 
        .stamina-bar { background-color: #48bb78; } 
        .relationship-bar { background-color: #d53f8c; } 
        .dungeon-time-bar { background-color: #dd6b20; }
        .stat-value { font-weight: bold; color: #a0aec0; }
        .item-name { color: #63b3ed; } 
        .item-stat-summary { font-size: 0.7rem; color: #90cdf4; margin-left: 4px; }
        .item-effect { color: #9f7aea; }
        .accolade-name, .title-name, .blessing-name, .curse-name { color: #f6e05e; cursor: pointer; text-decoration: underline; } 
        .accolade-name:hover, .title-name:hover, .blessing-name:hover, .curse-name:hover { color: #faf089; }
        .gold-value { color: #f6e05e; font-weight: bold;}
        .class-choice-card { background-color: #4a5568; padding: 0.8rem; border-radius: 0.375rem; margin-bottom: 0.5rem; cursor: pointer; }
        .class-choice-card:hover { background-color: #2c5282; }
        .class-choice-card h4 { font-size: 1em; margin-bottom: 0.2em; }
        .class-choice-card p { font-size: 0.8em; margin-bottom: 0.1em; }
        .character-sheet h4 { font-size: 0.85em; margin-top: 0.5rem; }

        #itemBagModal .item-slot, #shopModal .shop-item-slot, #sellInterface .sell-item-slot, #manageCompanionsModal .companion-manage-slot, #deathMessagesModal .death-message-entry, #guildHallModal .quest-entry {
            background-color: #3f4a5a;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 0.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative; 
        }
        #deathMessagesModal .death-message-entry, #guildHallModal .quest-entry {
            display: block; 
            text-align: left;
        }
        #guildHallModal .quest-entry button { margin-top: 0.5rem; }

        #itemBagModal .item-slot .item-name-container, 
        #shopModal .shop-item-slot .item-name-container, 
        #sellInterface .sell-item-slot .item-name-container,
        #manageCompanionsModal .companion-manage-slot .companion-name-container {
            flex-grow: 1;
            text-align: left;
        }

        #itemBagModal .item-slot .item-name, #shopModal .shop-item-slot .item-name, #sellInterface .sell-item-slot .item-name, #manageCompanionsModal .companion-manage-slot .companion-name {
            font-weight: bold;
            color: #63b3ed;
        }
        #itemBagModal .item-slot .btn-equip, #shopModal .shop-item-slot .btn-buy, #sellInterface .sell-item-slot .btn-sell, #manageCompanionsModal .companion-manage-slot .btn-part-ways {
            background-color: #38a169;
            color: white;
            margin-left: 0.5rem;
            padding: 0.3rem 0.6rem;
            font-size: 0.75rem;
        }
        #sellInterface .sell-item-slot .btn-sell, #manageCompanionsModal .companion-manage-slot .btn-part-ways { background-color: #e53e3e; }
        #sellInterface .sell-item-slot .btn-sell:hover, #manageCompanionsModal .companion-manage-slot .btn-part-ways:hover { background-color: #c53030; }
        #itemBagModal .item-slot .btn-equip:hover, #shopModal .shop-item-slot .btn-buy:hover {
            background-color: #2f855a;
        }
        .item-tooltip {
            position: absolute;
            background-color: #1a202c;
            border: 1px solid #4a5568;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            z-index: 101; 
            bottom: 100%; 
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            margin-bottom: 5px; 
            pointer-events: none; 
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .item-slot:hover .item-tooltip, .shop-item-slot:hover .item-tooltip, .sell-item-slot:hover .item-tooltip { 
            opacity: 1;
        }
         #shopModal .shop-item-cost, #sellInterface .sell-item-price {
            color: #f6e05e; 
            margin-left: 0.5rem;
            font-size: 0.8rem;
        }
        #charCompanionsList .companion-entry {
            padding: 0.25rem 0;
            border-bottom: 1px solid #3a4150;
        }
        #charCompanionsList .companion-entry:last-child {
            border-bottom: none;
        }
        #charCompanionsList .companion-name {
            font-weight: 600;
            color: #90cdf4; 
        }
        #charCompanionsList .companion-type {
            font-style: italic;
            color: #a0aec0;
        }
        .shop-tabs {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 1px solid #4a5568;
        }
        .shop-tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .shop-tab.active {
            border-bottom-color: #ecc94b;
            color: #ecc94b;
            font-weight: bold;
        }
        #gameOverScreen {
            background-color: #2d3748;
            padding: 2rem;
            border-radius: 0.5rem;
            text-align: center;
            border: 2px solid #c53030;
        }
        #gameOverScreen h2 {
            color: #c53030;
        }

    </style>
</head>
<body>
    <div id="gameContainer" class="game-container">
        <h1 id="gameTitle" class="game-title-header font-bold text-center mb-3 title-font">
            You Died in a Random Way But Was Reborn by the Primordial Goddess of Love and Justice to Help a World Where You're Born Anew
        </h1>
        
        <div id="initialLoadPrompt" class="text-center hidden"></div>
        <div id="occupationSelection" class="text-center hidden"></div>
        <div id="classSelection" class="hidden">
            <h2 id="classSelectionTitle" class="text-xl md:text-2xl mb-3 text-center title-font">The Goddess Offers You a Path...</h2>
            <p id="classSelectionIntro" class="text-center mb-3"></p>
            <div id="classChoicesContainer"></div>
        </div>
        <div id="eventDisplay" class="hidden mt-4">
             <h2 id="eventTitleElem" class="text-xl md:text-2xl mb-2"></h2>
             <p id="eventTextElem" class="mb-3 text-md md:text-lg"></p>
             <button id="continueButtonElem" class="btn btn-primary mx-auto block">Continue</button>
        </div>
        <div id="gameOverScreen" class="hidden mt-4">
            <h2 class="text-3xl title-font mb-4">Game Over</h2>
            <p id="finalDeathMessage" class="text-lg mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="newGameFromDeathButton" class="btn btn-primary">Start New Life</button>
                <button id="viewPastDeathsFromDeathButton" class="btn btn-info">View Past Deaths</button>
            </div>
        </div>


        <div id="newLifeInterface" class="hidden mt-4">
            <div class="grid md:grid-cols-3 gap-3">
                <div id="characterSheet" class="md:col-span-1 bg-gray-700 p-2 rounded overflow-y-auto max-h-[90vh]">
                    <h3 class="text-md font-semibold mb-1 title-font">Character Sheet</h3>
                    <div id="charDate"></div>
                    <div id="charName"></div>
                    <div id="charAge"></div>
                    <div id="charGold"></div> 
                    <div id="charWorld"></div>
                    <div id="charRank"></div>
                    <div id="charPowerScore"></div> 
                    <div id="charHP"></div>
                    <div id="charStamina"></div> 
                    <div id="charRankXP"></div>
                    <div id="charClass"></div>
                    <h4 class="text-sm font-semibold mt-1 mb-0.5 title-font">Elemental Spirit:</h4>
                    <div id="charElementalSpirit"></div>
                    <h4 class="text-sm font-semibold mt-1 mb-0.5 title-font">Companions:</h4>
                    <div id="charCompanionsList"></div> 
                    <div id="charChildren"></div>
                    <h4 class="text-sm font-semibold mt-1 mb-0.5 title-font">Stats (Base):</h4>
                    <div id="charBaseStats"></div>
                    <h4 class="text-sm font-semibold mt-1 mb-0.5 title-font">Effective Stats (w/ Items & Spirit):</h4>
                    <div id="charEffectiveStats"></div>
                    <h4 class="text-sm font-semibold mt-1 mb-0.5 title-font">Accolades:</h4>
                    <div id="charAccolades"></div>
                    <h4 class="text-sm font-semibold mt-1 mb-0.5 title-font">Titles:</h4>
                    <div id="charTitles"></div>
                    <h4 class="text-sm font-semibold mt-1 mb-0.5 title-font">Equipment:</h4>
                    <div id="charEquipment"></div>
                    <h4 class="text-sm font-semibold mt-1 mb-0.5 title-font">Treasures:</h4>
                    <div id="charTreasures"></div>
                    <h4 class="text-sm font-semibold mt-1 mb-0.5 title-font">Blessings:</h4>
                    <div id="charBlessings"></div>
                    <h4 class="text-sm font-semibold mt-1 mb-0.5 title-font">Curses:</h4>
                    <div id="charCurses"></div>
                </div>

                <div class="md:col-span-2">
                    <div id="worldActionsContainer">
                         <h3 class="text-md font-semibold mb-1 title-font">World Actions:</h3>
                         <div id="actionsContainer" class="action-button-container mb-2"></div>
                         <button id="viewPastDeathsButtonUI" class="btn btn-deaths w-full mb-2 hidden">View Past Deaths</button>
                         <button id="saveGameButtonUI" class="btn btn-save w-full mb-2">Save Game</button>
                         <button id="itemBagButtonUI" class="btn btn-bag w-full mb-2">Item Bag</button>
                         <button id="manageCompanionsButtonUI" class="btn btn-manage-social w-full mb-2">Manage Companions</button>
                         <button id="advanceYearButtonUI" class="btn btn-primary w-full mb-2">Sleep till Next Year</button>
                    </div>
                    <div id="dungeonInterface" class="hidden">
                         <h3 id="dungeonName" class="text-md font-semibold mb-1 title-font"></h3>
                         <div id="dungeonStatus"></div>
                         <div id="dungeonActionsContainer" class="action-button-container mt-1">
                             <button id="dungeonExploreButton" class="btn btn-dungeon">Explore Deeper</button>
                             <button id="dungeonRestButton" class="btn btn-info">Rest (1 Turn)</button>
                             <button id="dungeonFleeButton" class="btn btn-danger">Flee Dungeon</button>
                         </div>
                    </div>
                    <h3 class="text-md font-semibold mt-2 mb-1 title-font">Event Log:</h3>
                    <div id="eventLog" class="bg-gray-700 p-2 rounded max-h-40 overflow-y-auto text-xs"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="messageModal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modalTitle" class="text-xl title-font mb-3">Notification</h3>
            <p id="modalMessageText" class="text-md mb-4"></p>
            <button id="modalCloseButton" class="btn btn-primary">OK</button>
        </div>
    </div>

    <div id="elementalSpiritModal" class="modal hidden">
        <div class="modal-content">
            <h3 id="spiritModalTitle" class="text-xl title-font mb-3">A Spirit Appears!</h3>
            <p id="spiritModalMessage" class="text-md mb-4"></p>
            <div class="flex justify-center gap-4">
                <button id="bondSpiritButton" class="btn btn-action">Attempt to Bond</button>
                <button id="declineSpiritButton" class="btn btn-danger">Decline</button>
            </div>
        </div>
    </div>

    <div id="itemBagModal" class="modal hidden">
        <div class="modal-content !text-left max-w-lg"> 
            <h3 class="text-xl title-font mb-3 text-center">Item Bag</h3>
            <div id="itemBagContent" class="max-h-80 overflow-y-auto pr-2"> 
            </div>
            <button id="closeItemBagButton" class="btn btn-primary mt-4 w-full">Close Bag</button>
        </div>
    </div>

    <div id="shopModal" class="modal hidden">
        <div class="modal-content !text-left max-w-xl"> 
            <h3 id="shopName" class="text-xl title-font mb-3 text-center">Welcome to the Shop!</h3>
            <p class="text-center mb-2">Your Gold: <span id="shopPlayerGold" class="gold-value">0</span></p>
            <div class="shop-tabs">
                <div id="buyTab" class="shop-tab active">Buy</div> 
                <div id="sellTab" class="shop-tab">Sell</div>      
            </div>
            <div id="shopInventory" class="shop-tab-content max-h-80 overflow-y-auto pr-2">
                </div>
            <div id="sellInterface" class="shop-tab-content hidden max-h-80 overflow-y-auto pr-2">
                </div>
            <button id="closeShopButton" class="btn btn-primary mt-4 w-full">Leave Shop</button>
        </div>
    </div>
    
    <div id="manageCompanionsModal" class="modal hidden">
        <div class="modal-content !text-left max-w-lg">
            <h3 class="text-xl title-font mb-3 text-center">Manage Companions</h3>
            <div id="manageCompanionsContent" class="max-h-80 overflow-y-auto pr-2">
            </div>
            <button id="closeManageCompanionsButton" class="btn btn-primary mt-4 w-full">Close</button>
        </div>
    </div>

    <div id="deathMessagesModal" class="modal hidden">
        <div class="modal-content !text-left max-w-lg">
            <h3 class="text-xl title-font mb-3 text-center">Past Demises</h3>
            <div id="deathMessagesContent" class="max-h-80 overflow-y-auto pr-2">
            </div>
            <button id="closeDeathMessagesButton" class="btn btn-primary mt-4 w-full">Close</button>
        </div>
    </div>

    <div id="guildHallModal" class="modal hidden">
        <div class="modal-content !text-left max-w-lg">
            <h3 class="text-xl title-font mb-3 text-center">Adventurer's Guild</h3>
            <div id="guildQuestsContent" class="max-h-80 overflow-y-auto pr-2">
            </div>
            <div id="activeGuildQuestDisplay" class="mt-4 p-2 bg-gray-600 rounded hidden">
                <h4 class="font-semibold">Active Quest:</h4>
                <p id="activeQuestTitle"></p>
                <p id="activeQuestDescription" class="text-sm"></p>
                <button id="completeGuildQuestButton" class="btn btn-action mt-2">Attempt to Complete</button>
            </div>
            <button id="closeGuildHallButton" class="btn btn-primary mt-4 w-full">Leave Guild</button>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => { 
        const SAVE_KEY = "isekaiLifeSim_YDIARWBWRBTGOLAJTHAWYBA_v8_harem_robust_final"; 
        const RANKS = ["F", "E", "D", "C", "B", "A", "S", "SS", "SSS"]; 
        const RANK_REQUIREMENTS = { 
            "F": { xp: 0, powerScore: 0 },
            "E": { xp: 50, powerScore: 40 },
            "D": { xp: 150, powerScore: 70 },
            "C": { xp: 300, powerScore: 110 },
            "B": { xp: 500, powerScore: 160 },
            "A": { xp: 800, powerScore: 220 },
            "S": { xp: 1200, powerScore: 300 },
            "SS": { xp: 2000, powerScore: 400 },
            "SSS": { xp: 3000, powerScore: 550 }
        };
        const COMPANION_NAMES = ["Elara", "Ronan", "Seraphina", "Kael", "Lyra", "Jasper", "Astrid", "Finnian", "Aiko", "Kenji", "Leif", "Brynn", "Corbin", "Isolde", "Rowan", "Mira", "Gideon", "Clara"];
        const CHILD_NAMES = ["Leo", "Mia", "Noel", "Iris", "Sam", "Chloe", "Alex", "Zoe", "Ren", "Yuki"];
        const JAPANESE_NAME_ROOTS = ["Aki", "Haru", "Ken", "Yoshi", "Masa", "Nao", "Ryo", "Shin", "Taka", "Yumi", "Kaz", "Dai", "Ren", "Sora", "Kai", "Hana", "Yuki", "Ai", "Mei", "Saki"];
        const JAPANESE_NAME_ENDINGS = ["hiro", "hiko", "jiro", "suke", "kazu", "masa", "aki", "nosuke", "maru", "ko", "mi", "ka", "na", "ya", "to", "ru", "ma", "ne", "ri"];
        const DAYS_IN_MONTH = 30; 
        const MONTHS_IN_YEAR = 12;
        const FRIENDSHIP_TO_ROMANCE_THRESHOLD = 60;
        const MIN_ROMANCE_AGE = 16;
        const CHILD_BEARING_BOND_LEVEL = 80;
        const MIN_STAMINA_FOR_PHYSICAL_ACTION = 10; 
        const MAX_COMPANIONS = 5;
        const POLYAMOROUS_CHANCE = 0.3; 

        const ITEM_RARITIES = {
            E: { name: "Inferior", color: "text-gray-500", statPointsMultiplier: 0.5, costMultiplier: 0.5, maxStatTypes: 1, maxBasePointsPerStat: 2, chanceWeight: 30 },
            D: { name: "Common", color: "text-gray-400", statPointsMultiplier: 0.8, costMultiplier: 0.8, maxStatTypes: 1, maxBasePointsPerStat: 3, chanceWeight: 25 },
            C: { name: "Uncommon", color: "text-green-400", statPointsMultiplier: 1, costMultiplier: 1, maxStatTypes: 2, maxBasePointsPerStat: 4, chanceWeight: 20 },
            B: { name: "Rare", color: "text-blue-400", statPointsMultiplier: 1.5, costMultiplier: 1.5, maxStatTypes: 2, maxBasePointsPerStat: 5, chanceWeight: 15 },
            A: { name: "Epic", color: "text-purple-400", statPointsMultiplier: 2, costMultiplier: 2.5, maxStatTypes: 3, maxBasePointsPerStat: 6, chanceWeight: 7 },
            S: { name: "Legendary", color: "text-orange-400", statPointsMultiplier: 3, costMultiplier: 5, maxStatTypes: 3, maxBasePointsPerStat: 7, chanceWeight: 2.5 },
            SS: { name: "Mythic", color: "text-red-500", statPointsMultiplier: 4, costMultiplier: 10, maxStatTypes: 4, maxBasePointsPerStat: 8, chanceWeight: 0.4 },
            SSS: { name: "Transcendent", color: "text-yellow-300", statPointsMultiplier: 5, costMultiplier: 20, maxStatTypes: 4, maxBasePointsPerStat: 10, chanceWeight: 0.1 }
        };
        const ITEM_BASE_TYPES = [
            { name: "Dagger", type: "weapon", slot: "weapon", baseCost: 10, possibleStats: ["STR", "DEX", "LUCK"] },
            { name: "Shortsword", type: "weapon", slot: "weapon", baseCost: 20, possibleStats: ["STR", "DEX"] },
            { name: "Staff", type: "weapon", slot: "weapon", baseCost: 18, possibleStats: ["INT", "WIS", "MANA"] },
            { name: "Leather Cap", type: "armor", slot: "armor", baseCost: 8, possibleStats: ["CON", "DEX", "WIS"] }, 
            { name: "Cloth Robes", type: "armor", slot: "armor", baseCost: 12, possibleStats: ["INT", "WIS", "MANA", "CHA"] },
            { name: "Wooden Shield", type: "misc", slot: "misc", baseCost: 15, possibleStats: ["CON", "STR"] }, 
            { name: "Amulet", type: "misc", slot: "misc", baseCost: 25, possibleStats: ["INT", "WIS", "CHA", "LUCK", "MANA"] },
            { name: "Ring", type: "misc", slot: "misc", baseCost: 22, possibleStats: ["STR", "DEX", "CON", "INT", "WIS", "CHA", "LUCK", "MANA"] }
        ];
        const POSSIBLE_ITEM_STATS = ["STR", "DEX", "CON", "INT", "WIS", "CHA", "LUCK", "MANA"];
        const MONSTER_MATERIALS = [
            { name: "Slime Core", type: "material", baseSellValue: 2, rarity: "D" },
            { name: "Wolf Pelt", type: "material", baseSellValue: 5, rarity: "D" },
            { name: "Goblin Ear", type: "material", baseSellValue: 3, rarity: "D" },
            { name: "Wyvern Scale", type: "material", baseSellValue: 20, rarity: "B" },
            { name: "Demon Horn Fragment", type: "material", baseSellValue: 50, rarity: "A" }
        ];

        const gameData = {
            occupations: [ 
                { 
                    name: "Software Developer", 
                    deathScenarios: ["Chair collapse critical error.", "Server explosion.", "Electrocution via energy drink."],
                    classChoices: [
                        { name: "Techno-Mancer", description: "Blends logic with magic.", baseStats: { STR: 6, DEX: 8, CON: 10, INT: 15, WIS: 12, CHA: 9, LUCK: 5, MANA: 120 }, equipment: [{ name: "Traveler's Clothes", type: "armor", slot:"armor", stats: { CON: 1 } }, { name: "Satchel", type: "misc", slot:"misc", stats: {} }, { name: "Codex of Runes", type: "weapon", slot:"weapon", stats: { INT: 2, MANA: 10 } }], blessings: [{id: "systemic_thought", name:"Systemic Thought", description: "Occasionally allows for more logical solutions to problems."}], curses: [{id: "mundane_origin", name:"Mundane Origin", description: "Slightly harder to impress magical beings."}] },
                        { name: "Data Scryer", description: "Sees patterns in mana like data streams.", baseStats: { STR: 5, DEX: 7, CON: 9, INT: 16, WIS: 14, CHA: 8, LUCK: 6, MANA: 130 }, equipment: [{ name: "Analyst's Robes", type: "armor", slot:"armor", stats: { INT: 1 } }, { name: "Scrying Lens", type: "misc", slot:"misc", stats: { WIS: 1 } }, { name: "Note-taking Quill", type: "weapon", slot:"weapon", stats: { INT: 1 } }], blessings: [{id:"mana_sight", name:"Mana Sight", description: "Can sometimes sense ambient mana fluctuations."}], curses: [{id:"physically_weak", name:"Physically Weak", description: "More susceptible to physical exhaustion."}] },
                        { name: "Automation Golemancer", description: "Animates constructs with logical precision.", baseStats: { STR: 7, DEX: 6, CON: 11, INT: 14, WIS: 10, CHA: 10, LUCK: 5, MANA: 110 }, equipment: [{ name: "Artisan's Garb", type: "armor", slot:"armor", stats: { STR: 1 } }, { name: "Tool Kit", type: "misc", slot:"misc", stats: {} }, { name: "Blueprint Scraps", type: "weapon", slot:"weapon", stats: { CON: 1 } }], blessings: [{id:"efficient_crafting", name:"Efficient Crafting", description: "Uses fewer resources when building or repairing."}], curses: [{id:"socially_awkward", name:"Socially Awkward", description: "Minor penalties in some social interactions."}] }
                    ]
                },
                { 
                    name: "Chef",
                    deathScenarios: ["Fatal grease fire.", "Slip with boiling soup.", "Mistaken ingredient."],
                    classChoices: [
                        { name: "Alchemic Cook", description: "Infuses food with potion effects.", baseStats: { STR: 8, DEX: 10, CON: 12, INT: 10, WIS: 13, CHA: 11, LUCK: 6, MANA: 100 }, equipment: [{ name: "Sturdy Apron", type: "armor", slot:"armor", stats: { CON: 1 } }, { name: "Chef's Knife", type: "weapon", slot:"weapon", stats: { DEX: 1 } }, { name: "Spice Pouch", type: "misc", slot:"misc", stats: {} }], blessings: [{id:"enhanced_palate", name:"Enhanced Palate", description:"Can identify ingredients and effects in food more easily."}], curses: [{id:"aroma_magnet", name:"Aroma Magnet", description:"Your cooking attracts unwanted attention (both good and bad)."}] },
                        { name: "Battle Gourmand", description: "Fights with culinary tools and invigorating meals.", baseStats: { STR: 11, DEX: 9, CON: 13, INT: 8, WIS: 10, CHA: 12, LUCK: 5, MANA: 90 }, equipment: [{ name: "Reinforced Chef's Whites", type: "armor", slot:"armor", stats: { STR: 1 } }, { name: "Cleaver", type: "weapon", slot:"weapon", stats: { STR: 2 } }, { name: "Iron Skillet", type: "misc", slot:"misc", stats: { CON: 1 } }], blessings: [{id:"hearty_constitution", name:"Hearty Constitution", description:"Recovers from exhaustion and minor wounds faster."}], curses: [{id:"always_hungry", name:"Always Hungry", description:"Requires more frequent sustenance."}] },
                        { name: "Tavern Keeper Sage", description: "Gathers info and offers surprisingly good advice.", baseStats: { STR: 7, DEX: 8, CON: 10, INT: 12, WIS: 14, CHA: 13, LUCK: 7, MANA: 90 }, equipment: [{ name: "Comfortable Clothes", type: "armor", slot:"armor", stats: { CHA: 1 } }, { name: "Coin Pouch", type: "misc", slot:"misc", stats: {} }, { name: "Recipe Book", type: "weapon", slot:"weapon", stats: { WIS: 1 } }], blessings: [{id:"people_person", name:"People Person", description:"Gains favor more easily in social settings."}], curses: [{id:"slightly_overweight", name:"Slightly Overweight", description:"Minor penalty to DEX-based actions."}] }
                    ]
                },
                 {
                    name: "High School Student",
                    deathScenarios: ["Texting into manhole.", "Science fair explosion.", "Cafeteria mystery meat."],
                    classChoices: [
                        { name: "Generic Hero Protagonist", description: "Surprisingly adaptable.", baseStats: { STR: 10, DEX: 10, CON: 10, INT: 10, WIS: 10, CHA: 10, LUCK: 7, MANA: 100 }, equipment: [{ name: "School Uniform", type: "armor", slot:"armor", stats: {} }, { name: "Smartphone (no signal)", type: "misc", slot:"misc", stats: {} }, { name: "Textbook", type: "weapon", slot:"weapon", stats: { INT: 1 } }], blessings: [{id:"plot_armor_minor", name:"Plot Armor (Minor)", description:"Slightly higher chance to avoid dire consequences from mistakes."}], curses: [{id:"oblivious", name:"Oblivious", description:"Sometimes misses important social cues or environmental details."}] },
                        { name: "Bookish Magic Aspirant", description: "Dreamt of magic.", baseStats: { STR: 7, DEX: 8, CON: 9, INT: 14, WIS: 13, CHA: 8, LUCK: 6, MANA: 120 }, equipment: [{ name: "Thick Glasses", type: "misc", slot:"misc", stats: { INT: 1 } }, { name: "Fantasy Novels", type: "misc", slot:"misc", stats: {} }, { name: "Library Card", type: "misc", slot:"misc", stats: {} }], blessings: [{id:"quick_study_magic", name:"Quick Study (Magic)", description:"Learns magical concepts faster."}], curses: [{id:"physically_frail", name:"Physically Frail", description:"Lower starting HP and stamina."}] },
                        { name: "Sporty Brawler", description: "All brawn, some agility.", baseStats: { STR: 13, DEX: 12, CON: 12, INT: 8, WIS: 8, CHA: 9, LUCK: 5, MANA: 80 }, equipment: [{ name: "Tracksuit", type: "armor", slot:"armor", stats: { DEX: 1 } }, { name: "Sneakers", type: "misc", slot:"misc", stats: { DEX: 1 } }, { name: "Water Bottle", type: "misc", slot:"misc", stats: {} }], blessings: [{id:"athletic_prowess", name:"Athletic Prowess", description:"Excels at physical tasks."}], curses: [{id:"not_a_thinker", name:"Not a Thinker", description:"Penalties on INT and WIS based challenges."}] }
                    ]
                },
                {
                    name: "Art Student",
                    deathScenarios: ["Turpentine incident.", "Sculpture fell.", "Critiqued to death."],
                    classChoices: [
                        { name: "Illusion Weaver", description: "Paints reality with mana.", baseStats: { STR: 6, DEX: 9, CON: 8, INT: 13, WIS: 12, CHA: 14, LUCK: 7, MANA: 110 }, equipment: [{ name: "Art Smock", type: "armor", slot:"armor", stats: { CHA: 1 } }, { name: "Enchanted Brush Set", type: "weapon", slot:"weapon", stats: { INT: 2 } }, { name: "Sketchbook", type: "misc", slot:"misc", stats: {} }], blessings: [{id:"creative_flow", name:"Creative Flow", description:"Enhanced results when creating or improvising."}], curses: [{id:"easily_distracted", name:"Easily Distracted", description:"May lose focus during prolonged tasks."}] },
                        { name: "Bardic Muse", description: "Inspires through performance art.", baseStats: { STR: 7, DEX: 10, CON: 9, INT: 11, WIS: 11, CHA: 15, LUCK: 6, MANA: 100 }, equipment: [{ name: "Stylish Outfit", type: "armor", slot:"armor", stats: { CHA: 2 } }, { name: "Lute (slightly damaged)", type: "weapon", slot:"weapon", stats: { CHA: 1 } }, { name: "Songbook", type: "misc", slot:"misc", stats: {} }], blessings: [{id:"charming_presence", name:"Charming Presence", description:"Naturally sways opinions and gains attention."}], curses: [{id:"stage_fright_initial", name:"Stage Fright (Initially)", description:"Early performances may suffer from nervousness."}] },
                        { name: "Runic Sculptor", description: "Carves power into materials.", baseStats: { STR: 8, DEX: 7, CON: 10, INT: 14, WIS: 10, CHA: 9, LUCK: 5, MANA: 120 }, equipment: [{ name: "Sturdy Apron", type: "armor", slot:"armor", stats: { STR: 1 } }, { name: "Chisels", type: "weapon", slot:"weapon", stats: { INT: 1 } }, { name: "Clay Molds", type: "misc", slot:"misc", stats: {} }], blessings: [{id:"steady_hand", name:"Steady Hand", description:"Greater precision in delicate tasks."}], curses: [{id:"perfectionist", name:"Perfectionist", description:"Takes longer to complete tasks due to meticulousness."}] }
                    ]
                },
                {
                    name: "Engineering Student",
                    deathScenarios: ["Bridge collapse simulation too real.", "Robot uprising (small scale).", "Soldering iron mishap."],
                    classChoices: [
                        { name: "Trap Master", description: "Designs intricate magical traps.", baseStats: { STR: 7, DEX: 11, CON: 9, INT: 15, WIS: 12, CHA: 8, LUCK: 6, MANA: 100 }, equipment: [{ name: "Toolbelt", type: "misc", slot:"misc", stats: {} }, { name: "Safety Goggles", type: "misc", slot:"misc", stats: {} }, { name: "Mechanical Parts", type: "misc", slot:"misc", stats: {} }], blessings: [{id:"problem_solver", name:"Problem Solver", description:"Adept at finding unconventional solutions."}], curses: [{id:"overly_complex_plans", name:"Overly Complex Plans", description:"Sometimes makes things harder than they need to be."}] },
                        { name: "Siege Artificer", description: "Builds mana-powered siege engines.", baseStats: { STR: 9, DEX: 6, CON: 12, INT: 14, WIS: 10, CHA: 9, LUCK: 5, MANA: 110 }, equipment: [{ name: "Heavy Work Clothes", type: "armor", slot:"armor", stats: { CON: 1 } }, { name: "Wrench Set", type: "weapon", slot:"weapon", stats: { STR: 1 } }, { name: "Drafting Tools", type: "misc", slot:"misc", stats: {} }], blessings: [{id:"structural_integrity", name:"Structural Integrity", description:"Creations are more durable."}], curses: [{id:"needs_more_resources", name:"Needs More Resources", description:"Often requires more materials than initially estimated for crafting or projects."}] },
                        { name: "Mana-Circuit Engineer", description: "Optimizes mana flow in devices.", baseStats: { STR: 6, DEX: 8, CON: 8, INT: 16, WIS: 13, CHA: 7, LUCK: 7, MANA: 130 }, equipment: [{ name: "Lab Coat", type: "armor", slot:"armor", stats: { INT: 1 } }, { name: "Fine Wires", type: "misc", slot:"misc", stats: {} }, { name: "Magnifying Glass", type: "misc", slot:"misc", stats: { WIS: 1 } }], blessings: [{id:"logical_precision", name:"Logical Precision", description:"Excels at tasks requiring exact calculations."}], curses: [{id:"energy_fluctuations", name:"Energy Fluctuations", description:"Mana-powered devices may sometimes behave erratically."}] }
                    ]
                }
            ],
            worlds: [ 
                { 
                    id: "veridia", 
                    name: "Veridia, Land of Conflict",
                    description: "Veridia is besieged by the forces of the Demon King Xylar. Your destiny may be to stand against this encroaching darkness.",
                    theme: "demon_king",
                    lateGameActions: [
                        { id: "veridia_fortress", name: "Assault Demon Fortress", timeCost: 15, hpCostRange: [40,70], staminaCost: 40, rankXP: 50, result: "A brutal siege, but the fortress falls! Lost {hpLost} HP.", rankReq: "A", isWorldSpecific: true, isBattle: true, grantsTitle: { id: "fortress_breaker", name: "Fortress Breaker", chance: 0.25 }, difficultyBonus: 2.8, significantEvent: true }, 
                        { id: "veridia_blade", name: "Seek Legendary Blade", timeCost: 20, hpCostRange: [20,40], staminaCost: 30, rankXP: 30, result: "After a perilous quest, you find the Sunfire Blade! Took {hpLost} HP in trials.", rankReq: "A", isWorldSpecific: true, effects: {STR: 5, LUCK: 2}, difficultyBonus: 3.0, grantsItem: { name: "Sunfire Blade", type: "weapon", slot:"weapon", stats: { STR: 10, LUCK: 2, MANA: 10 }, significant: true, rarity: "S" }, significantEvent: true, unique: true }, 
                        { id: "veridia_demon_king", name: "Confront Demon King Xylar", timeCost: 10, hpCostRange: [60,100], staminaCost: 50, rankXP: 100, result: "The final battle! You defeated Xylar, but at great cost: {hpLost} HP. Veridia is saved!", rankReq: "S", isWorldSpecific: true, isBattle: true, isGameEnd: true, grantsTitle: { id: "hero_of_veridia", name: "Hero of Veridia", chance: 1.0 }, difficultyBonus: 3.5, significantEvent: true } 
                    ]
                },
                {
                    id: "aethelgard",
                    name: "Aethelgard, Realm of Ancient Magic",
                    description: "Aethelgard is a world steeped in forgotten lore, where ancient magical constructs awaken and the very fabric of magic is unraveling. Seek the heart of the mystery.",
                    theme: "arcane_mystery",
                    lateGameActions: [
                        { id: "aethel_tablets", name: "Decipher Chronos Tablets", timeCost: 25, hpCostRange: [5,15], staminaCost: 10, rankXP: 40, result: "The tablets reveal secrets of creation! Mental strain cost {hpLost} HP.", rankReq: "A", isWorldSpecific: true, effects: {INT: 3, WIS: 3}, difficultyBonus: 1.8, significantEvent: true, unique: true },
                        { id: "aethel_wellspring", name: "Stabilize Mana Wellspring", timeCost: 10, hpCostRange: [20,50], staminaCost: 25, rankXP: 35, result: "You channeled immense power to stabilize the wellspring. Lost {hpLost} HP.", rankReq: "A", isWorldSpecific: true, effects: {MANA: 20}, grantsTitle: { id: "wellspring_guardian", name: "Wellspring Guardian", chance: 0.3 }, difficultyBonus: 2.2, significantEvent: true },
                        { id: "aethel_guardian", name: "Confront Awakened Guardian", timeCost: 12, hpCostRange: [50,80], staminaCost: 40, rankXP: 60, result: "The ancient guardian tested your worth. You prevailed, losing {hpLost} HP.", rankReq: "S", isWorldSpecific: true, isBattle: true, grantsTitle: {id: "ancient_vanquisher", name: "Ancient Vanquisher", chance: 0.5}, difficultyBonus: 3.2, significantEvent: true },
                        { id: "aethel_arch_chancellor", name: "Become Arch-Chancellor", timeCost: 5, hpCostRange: [0,5], staminaCost: 5, rankXP: 0, result: "Your wisdom guides Aethelgard to a new era of magical balance. Took {hpLost} HP from stress. Aethelgard is at peace.", rankReq: "S", isWorldSpecific: true, isGameEnd: true, requiresStats: {INT: 25, WIS: 25, CHA: 20}, grantsTitle: {id: "arch_chancellor_aethel", name: "Arch-Chancellor of Aethelgard", chance: 1.0}, difficultyBonus: 0.8, significantEvent: true }
                    ]
                },
                {
                    id: "solara",
                    name: "Solara, The Sunken World",
                    description: "You awaken in Solara, a world once vibrant, now mostly submerged. Pockets of civilization cling to high plateaus and floating islands. Survival and rediscovery are paramount.",
                    theme: "exploration_survival",
                    lateGameActions: [
                        { id: "solara_sunken_city", name: "Explore Sunken City", timeCost: 30, hpCostRange: [10,40], staminaCost: 35, rankXP: 50, result: "You navigated the dangerous depths of the sunken city, finding ancient treasures but losing {hpLost} HP.", rankReq: "A", isWorldSpecific: true, effects: {LUCK: 3, INT: 2}, difficultyBonus: 2.5, grantsItem: { name: "Coral Circlet", type: "misc", slot:"misc", stats: { WIS: 2, MANA: 15 }, significant: true, rarity: "A" }, significantEvent: true, unique: true },
                        { id: "solara_leviathan", name: "Subdue Grand Leviathan", timeCost: 25, hpCostRange: [50,90], staminaCost: 50, rankXP: 70, result: "The colossal Leviathan was a fierce foe, but you managed to subdue it, taking {hpLost} HP damage.", rankReq: "S", isWorldSpecific: true, isBattle: true, grantsTitle: { id: "leviathan_tamer", name: "Leviathan Tamer", chance: 0.75 }, difficultyBonus: 3.8, significantEvent: true },
                        { id: "solara_resurface", name: "Initiate Resurface Protocol", timeCost: 40, hpCostRange: [20,60], staminaCost: 40, rankXP: 80, result: "Against all odds, you activated the ancient machinery, beginning Solara's resurfacing! A arduous task that cost {hpLost} HP. Solara slowly rises again.", rankReq: "S", isWorldSpecific: true, isGameEnd: true, requiresStats: {INT: 20, WIS: 20, CON: 20}, grantsTitle: { id: "savior_of_solara", name: "Savior of Solara", chance: 1.0 }, difficultyBonus: 2.8, significantEvent: true }
                    ]
                }
            ],
            elementalSpirits: [
                {
                    id: "fairy_of_verdure", name: "Fairy of Verdure", type: "Fairy", description: "A mischievous spirit tied to nature's vibrant growth.",
                    baseBoosts: { DEX: 1, LUCK: 1 }, boostPerLevel: { DEX: 0.5, LUCK: 0.2 }, maxBondLevel: 5,
                    bondMessages: ["The fairy flits around you, a comfortable presence.", "Your bond with the fairy deepens, you feel lighter and luckier.", "The fairy hums a joyful tune, imbuing you with its nimble energy.", "You understand the fairy's whispers, gaining insight into fortunate paths.", "The fairy is a constant companion, its verdant magic flowing through you, enhancing your grace." ]
                },
                {
                    id: "ember_dragonling", name: "Ember Dragonling", type: "Dragon", description: "A small, fiery dragon, fierce yet loyal.",
                    baseBoosts: { STR: 2, CON: 1 }, boostPerLevel: { STR: 1, CON: 0.5 }, maxBondLevel: 3,
                    bondMessages: ["The dragonling nuzzles your hand, a spark of warmth.", "Your connection to the dragonling solidifies, granting you greater strength and resilience.", "The dragonling's fiery spirit emboldens you, its power growing within your core." ]
                },
                {
                    id: "mana_wisp", name: "Mana Wisp", type: "Wisp", description: "A shimmering orb of pure mana, drawn to magical aptitude.",
                    baseBoosts: { INT: 1, MANA: 10 }, boostPerLevel: { INT: 0.5, MANA: 5 }, maxBondLevel: 4,
                    bondMessages: ["The wisp gently pulses near you, a calming arcane aura.", "You feel mana coalesce around the wisp, enhancing your own reserves and intellect.", "The wisp dances with increased vibrancy, amplifying your spells and thoughts.", "The wisp is a reservoir of arcane energy, a true partner in your magical endeavors." ]
                },
                {
                    id: "stone_golem_shard", name: "Stone Golem Shard", type: "Golem", description: "A living fragment of an ancient construct, strong and unyielding.",
                    baseBoosts: { STR: 1, CON: 2 }, boostPerLevel: { STR: 0.5, CON: 1 }, maxBondLevel: 3,
                    bondMessages: ["A solid presence emanates from the shard, grounding your power.", "The shard resonates with your will, fortifying your defenses and might.", "The golem shard grants you unwavering stability and formidable power." ]
                },
            ],
             accolades: [ 
                { id: "fortune_favorite", name: "Fortune's Favorite", description: "Lady Luck smiles upon you more often. Small passive LUCK boost." },
                { id: "charmer", name: "Charmer", description: "You have a way with words and a captivating presence. Small passive CHA boost." },
                { id: "harem_initiate", name: "Harem Initiate", description: "You've begun to walk the complicated path of many loves. Slight CHA boost, but increased social complexity." },
                { id: "harem_master", name: "Harem Master", description: "Your charm and diplomacy allow you to maintain multiple romantic relationships. Significant CHA boost, but relationships require more effort." },
                { id: "faithful_partner", name: "Faithful Partner", description: "Your loyalty in love is unwavering. Increased bond gain with your romantic partner." },
                { id: "friend_collector", name: "Friend Collector", description: "You have a knack for making and keeping many friends. Easier to make new friends." },
                { id: "heart_desire", name: "Heart's Desire", description: "You successfully confessed your feelings and found romance." }
            ],
            curses: [ 
                { id: "mundane_origin", name:"Mundane Origin", description: "Slightly harder to impress magical beings or understand deep magic." },
                { id: "physically_weak", name:"Physically Weak", description: "More susceptible to physical exhaustion and lower starting stamina." },
                { id: "socially_awkward", name:"Socially Awkward", description: "Minor penalties in some social interactions and CHA checks." },
                { id: "aroma_magnet", name:"Aroma Magnet", description:"Your cooking attracts unwanted attention (both good and bad creatures)." },
                { id: "always_hungry", name:"Always Hungry", description:"Requires more frequent sustenance or suffer minor CON penalties." },
                { id: "slightly_overweight", name:"Slightly Overweight", description:"Minor penalty to DEX-based actions and stamina regeneration." },
                { id: "oblivious", name:"Oblivious", description:"Sometimes misses important social cues, environmental details, or warnings." },
                { id: "physically_frail", name:"Physically Frail", description:"Lower starting HP and stamina, and slower recovery from wounds." },
                { id: "not_a_thinker", name:"Not a Thinker", description:"Penalties on INT and WIS based challenges and learning." },
                { id: "easily_distracted", name:"Easily Distracted", description:"May lose focus during prolonged tasks, potentially taking longer or failing." },
                { id: "stage_fright_initial", name:"Stage Fright (Initially)", description:"Early performances or public speaking may suffer from nervousness, reducing CHA effectiveness." },
                { id: "perfectionist", name:"Perfectionist", description:"Takes longer to complete tasks due to meticulousness, increasing time costs." },
                { id: "overly_complex_plans", name:"Overly Complex Plans", description:"Sometimes makes things harder than they need to be, potentially increasing difficulty or cost of actions." },
                { id: "needs_more_resources", name:"Needs More Resources", description:"Often requires more materials than initially estimated for crafting or projects." },
                { id: "energy_fluctuations", name:"Energy Fluctuations", description:"Mana-powered devices or spells may sometimes behave erratically." },
                { id: "untrustworthy", name: "Untrustworthy", description: "People are less likely to believe you. Social checks involving trust are harder. Harder to form new deep relationships." },
                { id: "heartbroken", name: "Heartbroken", description: "A deep sadness affects your spirit. Temporary substantial decrease to CHA and LUCK." },
                { id: "scorned_partner", name: "Scorned Partner", description: "An ex-lover holds a deep grudge and may actively try to cause you trouble." }
            ],
            blessings: [ 
                {id: "systemic_thought", name:"Systemic Thought", description: "Occasionally allows for more logical solutions to problems, providing bonuses to INT checks."},
                {id:"mana_sight", name:"Mana Sight", description: "Can sometimes sense ambient mana fluctuations, revealing hidden magical properties or auras."},
                {id:"efficient_crafting", name:"Efficient Crafting", description: "Uses fewer resources when building or repairing items."},
                {id:"enhanced_palate", name:"Enhanced Palate", description:"Can identify ingredients and effects in food more easily, potentially discovering new recipes or effects."},
                {id:"hearty_constitution", name:"Hearty Constitution", description:"Recovers from exhaustion and minor wounds faster. Increased natural HP and Stamina regeneration."},
                {id:"people_person", name:"People Person", description:"Gains favor more easily in social settings. Small bonus to CHA checks."},
                {id:"plot_armor_minor", name:"Plot Armor (Minor)", description:"Slightly higher chance to avoid dire consequences from mistakes or critical failures."},
                {id:"quick_study_magic", name:"Quick Study (Magic)", description:"Learns magical concepts and spells faster. XP gain for magical studies is increased."},
                {id:"athletic_prowess", name:"Athletic Prowess", description:"Excels at physical tasks. Small bonus to STR and DEX checks."},
                {id:"creative_flow", name:"Creative Flow", description:"Enhanced results when creating or improvising. Better quality crafted items or more impactful performances."},
                {id:"charming_presence", name:"Charming Presence", description:"Naturally sways opinions and gains attention. Improves success in diplomatic or persuasive encounters."},
                {id:"steady_hand", name:"Steady Hand", description:"Greater precision in delicate tasks, like crafting fine items or performing surgery."},
                {id:"problem_solver", name:"Problem Solver", description:"Adept at finding unconventional solutions to puzzles or obstacles."},
                {id:"structural_integrity", name:"Structural Integrity", description:"Creations are more durable and last longer."},
                {id:"logical_precision", name:"Logical Precision", description:"Excels at tasks requiring exact calculations or logical deduction."}
            ],
            ageSpecificActions: [
                { id: "play_kids", name: "Play with Local Kids", timeCost: 2, ageMin: 8, ageMax: 12, effects: { CHA: 0.2, LUCK: 0.1, XP: 1 }, staminaCost: 5, result: "You spent time playing with other children. (+0.2 CHA, +0.1 LUCK)", buttonClass: "btn-age-specific" },
                { id: "childhood_adventure", name: "Childhood Adventure (Explore)", timeCost: 4, ageMin: 8, ageMax: 12, effects: { DEX: 0.1, LUCK: 0.2, XP: 3 }, staminaCost: 10, result: "You explored the nearby woods. (+0.1 DEX, +0.2 LUCK)", grantsItemChance: 0.1, itemPool: [{ name: "Shiny Pebble", type: "misc", slot:"misc", stats: {LUCK: 0.1}, rarity: "E", cost: 1, sellPrice: 0 }], buttonClass: "btn-age-specific" },
                { id: "listen_elder", name: "Listen to Elder's Stories", timeCost: 1, ageMin: 8, ageMax: 14, effects: { WIS: 0.2, XP: 2 }, staminaGain: 5, result: "You listened intently to the village elder's tales. (+0.2 WIS)", buttonClass: "btn-age-specific" },
                { id: "odd_jobs", name: "Do Odd Jobs", timeCost: 5, ageMin: 13, ageMax: 17, effects: { STR: 0.1, CON: 0.1, XP: 5, GOLD: 5 }, staminaCost: 15, result: "You helped around the village with various tasks. (+5G, +0.1 STR, +0.1 CON)", buttonClass: "btn-age-specific" },
                { id: "first_quest_pest", name: "First Quest: Pest Extermination", timeCost: 7, ageMin: 13, ageMax: 17, effects: { XP: 10, GOLD: 15 }, staminaCost: 20, resultSuccess: "You successfully cleared out the pests plaguing the farmer's field! You earned some gold and valuable experience.", resultFail: "The pests were more numerous than expected. You managed to escape but took some bruises.", hpCostFail: [5, 10], combatCheck: { stat: "STR", difficulty: 8 }, buttonClass: "btn-age-specific", significantEvent: true },
                { id: "early_certification", name: "Request Early Certification", timeCost: 1, ageMin: 13, ageMax: 15, staminaCost: 5, resultSuccess: "Your earnest plea (and perhaps a bit of charm) convinced the guild! You're now a Provisional Adventurer!", resultFail: "They pat you on the head. 'Come back when you're a bit older, kid.'", chaCheck: 12, significantEvent: true, buttonClass: "btn-info" }
            ],
            utilityActions: [
                 { id: "rest_action", name: "Rest", timeCost: 2, staminaGain: 40, hpGain: 10, result: "You take some time to rest and recover your energy. You feel much better.", buttonClass: "btn-info", significantEvent: false },
                 { id: "visit_tavern", name: "Visit Tavern", timeCost: 1, ageMin: 13, goldCost: 5, effects: { HEAL_PERCENT: 0.25, CHA: 0.1 }, staminaGain: 10, result: "You spent some time at the tavern, enjoying a hearty meal and drink. You feel refreshed and a bit more sociable.", buttonClass: "btn-tavern", significantEvent: false }, 
                 { id: "visit_shop", name: "Visit Shop", timeCost: 1, ageMin: 13, staminaGain: 2, result: "You head to the local shop to see what's available.", buttonClass: "btn-shop", significantEvent: true }, 
                 { id: "visit_guild_hall", name: "Visit Guild Hall", timeCost: 1, ageMin: 13, requiresCertification: true, staminaGain: 2, result: "You enter the bustling Adventurer's Guild.", buttonClass: "btn-guild", significantEvent: true },
                 { id: "seek_companion", name: "Seek Companion", timeCost: 3, staminaCost: 5, buttonClass: "btn-romance", significantEvent: true }, 
                 { id: "confess_feelings", name: "Confess Feelings", timeCost: 2, staminaCost: 2, buttonClass: "btn-confess", significantEvent: true } 
            ],
            shopItems: [ 
                { id: "healing_potion_sm", name: "Small Healing Potion", type: "consumable", effect: { heal: 20 }, cost: 10, description: "Restores 20 HP.", rarity: "D", sellPrice: 3 },
                { id: "rusty_sword", name: "Rusty Sword", type: "weapon", slot:"weapon", stats: { STR: 1 }, cost: 25, description: "A basic, somewhat worn sword.", rarity: "E", sellPrice: 5 },
                { id: "leather_vest", name: "Leather Vest", type: "armor", slot:"armor", stats: { CON: 1 }, cost: 30, description: "Simple leather protection.", rarity: "E", sellPrice: 6 },
                { id: "mana_potion_sm", name: "Small Mana Potion", type: "consumable", effect: { mana: 15 }, cost: 15, description: "Restores 15 Mana.", rarity: "D", sellPrice: 4 }
            ],
            guildQuests: [ 
                { id: "guild_kill_goblins_veridia", title: "Goblin Cleanup (Veridia)", worldId: "veridia", 
                  description: "Goblins are harassing travelers on the outskirts of the capital.", type: "Extermination", 
                  target: "Goblins", timeCost: 5, staminaCost: 20, 
                  difficultyCheck: { stat: "STR", value: 8 }, 
                  rewards: { gold: 30, xp: 15, items: [{type: "material", name:"Goblin Ear", chance: 0.7}] } 
                },
                { id: "guild_collect_herbs_aethelgard", title: "Herbal Remedy (Aethelgard)", worldId: "aethelgard",
                  description: "The apothecary needs rare Moonpetal Flowers from the Whispering Woods.", type: "Collection", 
                  target: "Moonpetal Flowers", timeCost: 3, staminaCost: 15, 
                  difficultyCheck: { stat: "WIS", value: 8 }, 
                  rewards: { gold: 30, xp: 15 } 
                },
                { id: "guild_escort_merchant_solara", title: "Merchant Escort (Solara)", worldId: "solara",
                  description: "A merchant needs protection on the treacherous island paths.", type: "Escort", 
                  target: "Merchant", timeCost: 6, staminaCost: 30, 
                  difficultyCheck: { stat: "CHA", value: 10, secondaryStat: "CON", secondaryValue: 10 }, 
                  rewards: { gold: 70, xp: 25 } 
                },
                 { id: "guild_hunt_wolves_veridia", title: "Wolf Pack Problem (Veridia)", worldId: "veridia", 
                  description: "A pack of unusually aggressive wolves is threatening livestock.", type: "Extermination", 
                  target: "Aggressive Wolves", timeCost: 4, staminaCost: 25, rankReq: "E",
                  difficultyCheck: { stat: "DEX", value: 10 }, 
                  rewards: { gold: 40, xp: 20, items: [{type: "material", name:"Wolf Pelt", chance: 0.8}] } 
                }
            ]
        };

        // --- Global Game State Variables ---
        let player = {};
        let currentDungeon = null;
        let gameEnded = false;
        let eventInProgress = false; 
        let currentSpiritEncounter = null; 

        // --- UI Element References (Global within DOMContentLoaded) ---
        const initialLoadPrompt = document.getElementById('initialLoadPrompt');
        const occupationSelection = document.getElementById('occupationSelection');
        const classSelection = document.getElementById('classSelection');
        const classSelectionTitle = document.getElementById('classSelectionTitle');
        const classSelectionIntro = document.getElementById('classSelectionIntro');
        const classChoicesContainer = document.getElementById('classChoicesContainer');
        const newLifeInterface = document.getElementById('newLifeInterface');
        const charDate = document.getElementById('charDate');
        const charName = document.getElementById('charName');
        const charAge = document.getElementById('charAge');
        const charGold = document.getElementById('charGold'); 
        const charWorld = document.getElementById('charWorld');
        const charRank = document.getElementById('charRank');
        const charPowerScore = document.getElementById('charPowerScore');
        const charHP = document.getElementById('charHP');
        const charStamina = document.getElementById('charStamina'); 
        const charRankXP = document.getElementById('charRankXP');
        const charClass = document.getElementById('charClass');
        const charCompanionsList = document.getElementById('charCompanionsList'); 
        const charChildren = document.getElementById('charChildren');
        const charBaseStats = document.getElementById('charBaseStats');
        const charEffectiveStats = document.getElementById('charEffectiveStats');
        const charAccolades = document.getElementById('charAccolades');
        const charTitles = document.getElementById('charTitles');
        const charEquipment = document.getElementById('charEquipment');
        const charTreasures = document.getElementById('charTreasures');
        const charBlessings = document.getElementById('charBlessings');
        const charCurses = document.getElementById('charCurses');
        const actionsContainer = document.getElementById('actionsContainer');
        const eventLog = document.getElementById('eventLog');
        const advanceYearButtonUI = document.getElementById('advanceYearButtonUI');
        const saveGameButtonUI = document.getElementById('saveGameButtonUI');
        const eventDisplay = document.getElementById('eventDisplay');
        const eventTitleElem = document.getElementById('eventTitleElem');
        const eventTextElem = document.getElementById('eventTextElem');
        const continueButtonElem = document.getElementById('continueButtonElem');
        const gameOverScreen = document.getElementById('gameOverScreen'); 
        const finalDeathMessageElem = document.getElementById('finalDeathMessage');
        const newGameFromDeathButton = document.getElementById('newGameFromDeathButton');
        const viewPastDeathsFromDeathButton = document.getElementById('viewPastDeathsFromDeathButton');
        const dungeonInterface = document.getElementById('dungeonInterface');
        const dungeonNameElem = document.getElementById('dungeonName');
        const dungeonStatusElem = document.getElementById('dungeonStatus');
        const dungeonExploreButton = document.getElementById('dungeonExploreButton');
        const dungeonRestButton = document.getElementById('dungeonRestButton');
        const dungeonFleeButton = document.getElementById('dungeonFleeButton');
        const worldActionsContainer = document.getElementById('worldActionsContainer');
        const messageModal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessageText = document.getElementById('modalMessageText');
        const modalCloseButton = document.getElementById('modalCloseButton');
        const charElementalSpirit = document.getElementById('charElementalSpirit');
        const elementalSpiritModal = document.getElementById('elementalSpiritModal');
        const spiritModalTitleElem = document.getElementById('spiritModalTitle'); 
        const spiritModalMessageElem = document.getElementById('spiritModalMessage'); 
        const bondSpiritButton = document.getElementById('bondSpiritButton');
        const declineSpiritButton = document.getElementById('declineSpiritButton');
        const itemBagButtonUI = document.getElementById('itemBagButtonUI');
        const itemBagModal = document.getElementById('itemBagModal');
        const itemBagContent = document.getElementById('itemBagContent');
        const closeItemBagButton = document.getElementById('closeItemBagButton');
        const shopModal = document.getElementById('shopModal');
        const shopNameElem = document.getElementById('shopName');
        const shopPlayerGoldElem = document.getElementById('shopPlayerGold');
        const shopInventoryElem = document.getElementById('shopInventory');
        const sellInterfaceElem = document.getElementById('sellInterface');
        const closeShopButton = document.getElementById('closeShopButton');
        const buyTab = document.getElementById('buyTab');
        const sellTab = document.getElementById('sellTab');
        const manageCompanionsButtonUI = document.getElementById('manageCompanionsButtonUI');
        const manageCompanionsModal = document.getElementById('manageCompanionsModal');
        const manageCompanionsContent = document.getElementById('manageCompanionsContent');
        const closeManageCompanionsButton = document.getElementById('closeManageCompanionsButton');
        const viewPastDeathsButtonUI = document.getElementById('viewPastDeathsButtonUI');
        const deathMessagesModal = document.getElementById('deathMessagesModal');
        const deathMessagesContent = document.getElementById('deathMessagesContent');
        const closeDeathMessagesButton = document.getElementById('closeDeathMessagesButton');
        const guildHallModal = document.getElementById('guildHallModal');
        const guildQuestsContent = document.getElementById('guildQuestsContent');
        const activeGuildQuestDisplay = document.getElementById('activeGuildQuestDisplay');
        const activeQuestTitle = document.getElementById('activeQuestTitle');
        const activeQuestDescription = document.getElementById('activeQuestDescription');
        const completeGuildQuestButton = document.getElementById('completeGuildQuestButton');
        const closeGuildHallButton = document.getElementById('closeGuildHallButton');

        // --- GameManager Module ---
        const GameManager = {
            init: function() {
                const savedGame = this.load(); 
                if (savedGame) {
                    player = savedGame;
                    if (player.inventory === undefined) player.inventory = [];
                    if (player.bondedSpirit === undefined) player.bondedSpirit = null;
                    if (player.equipment === undefined || Array.isArray(player.equipment)) { 
                         player.equipment = { weapon: null, armor: null, misc: null };
                    }
                    if (player.gold === undefined) player.gold = 10; 
                    if (player.currentDate === undefined) { 
                        player.age = player.age || (Math.floor(Math.random() * 5) + 8); 
                        player.currentDate = { year: player.age, month: 1, day: 1 };
                    }
                    if (player.companions === undefined) player.companions = []; 
                    player.companions.forEach(comp => {
                        if(!comp.id) comp.id = Date.now() + Math.random();
                        if(comp.metAtAge === undefined) comp.metAtAge = player.age -1; 
                        if(comp.isPolyamorous === undefined) comp.isPolyamorous = (Math.random() < POLYAMOROUS_CHANCE); 
                    });
                    if (player.completedWorldEvents === undefined) player.completedWorldEvents = [];
                    if (player.powerScore === undefined) player.powerScore = 0;
                    if (player.stamina === undefined) player.stamina = 100;
                    if (player.maxStamina === undefined) player.maxStamina = 100;
                    if (player.deathMessages === undefined) player.deathMessages = [];
                    if (player.isCertifiedAdventurer === undefined) player.isCertifiedAdventurer = false;
                    if (player.activeGuildQuest === undefined) player.activeGuildQuest = null;


                    UIManager.showNewLifeInterface();
                    UIManager.updateUI();
                    UIManager.logEvent(`Game loaded! Welcome back, ${player.name}.`);
                    if (player.inDungeon) {
                        currentDungeon = gameData.worlds.find(w => w.id === player.world.id)
                                        .lateGameActions.find(a => a.id === player.inDungeon.dungeonActionId);
                        if (currentDungeon) {
                             UIManager.showDungeonInterface(currentDungeon);
                        }
                    }
                } else {
                    this.startNewGame();
                }
            },
            startNewGame: function() {
                const startingAge = Math.floor(Math.random() * 5) + 8; 
                const previousDeaths = player.deathMessages || []; 
                player = {
                    name: this.generateRandomName(), 
                    age: startingAge,
                    currentDate: { year: startingAge, month: 1, day: 1 }, 
                    gold: 20, 
                    occupation: null,
                    class: null,
                    baseStats: {},
                    effectiveStats: {},
                    powerScore: 0,
                    rank: "F",
                    rankXP: 0,
                    maxHP: 100,
                    currentHP: 100,
                    stamina: 100, 
                    maxStamina: 100, 
                    mana: 100,
                    maxMana: 100,
                    world: null,
                    companions: [], 
                    children: [],
                    accolades: [],
                    titles: [],
                    equipment: { weapon: null, armor: null, misc: null }, 
                    treasures: [], 
                    blessings: [],
                    curses: [],
                    inDungeon: null, 
                    bondedSpirit: null, 
                    inventory: [], 
                    completedWorldEvents: [], 
                    deathMessages: previousDeaths,
                    isCertifiedAdventurer: false,
                    activeGuildQuest: null 
                };
                gameEnded = false; 
                eventInProgress = false; 
                
                UIManager.hideGameOverScreen(); 
                UIManager.displayOccupationSelection();
                UIManager.logEvent(`Welcome to a new life, ${player.name}! You begin your journey at the age of ${player.age}.`);
                UIManager.updateUI(); 
            },
            generateRandomName: function() {
                const root = JAPANESE_NAME_ROOTS[Math.floor(Math.random() * JAPANESE_NAME_ROOTS.length)];
                const ending = JAPANESE_NAME_ENDINGS[Math.floor(Math.random() * JAPANESE_NAME_ENDINGS.length)];
                let name = root + ending;
                return name.charAt(0).toUpperCase() + name.slice(1);
            },
            advanceDate: function(days) {
                player.currentDate.day += days;
                while (player.currentDate.day > DAYS_IN_MONTH) {
                    player.currentDate.day -= DAYS_IN_MONTH;
                    player.currentDate.month++;
                    if (player.currentDate.month > MONTHS_IN_YEAR) {
                        player.currentDate.month = 1;
                        player.currentDate.year++;
                        player.age++; 
                        UIManager.logEvent(`Happy Birthday! You are now ${player.age}.`);
                    }
                }
            },
            advanceYear: function() { 
                if (eventInProgress || gameEnded) return;

                player.currentDate.day = 1;
                player.currentDate.month = 1;
                player.currentDate.year++;
                player.age++;
                player.stamina = player.maxStamina; 

                if (!player.inDungeon) {
                    player.currentHP = player.maxHP;
                    player.mana = player.maxMana;
                    UIManager.logEvent("A new year begins! Your HP, Mana, and Stamina have been restored.");
                } else {
                     UIManager.logEvent("A new year begins! Your Stamina has been restored.");
                }


                if (player.bondedSpirit) {
                    const spiritData = gameData.elementalSpirits.find(s => s.id === player.bondedSpirit.id);
                    if (spiritData && player.bondedSpirit.bondLevel < spiritData.maxBondLevel) {
                        if (Math.random() < 0.25 + ((player.effectiveStats.CHA || 0) * 0.01)) { 
                            player.bondedSpirit.bondLevel++;
                            UIManager.logEvent(`Your bond with the <span class="font-bold text-cyan-300">${spiritData.name}</span> deepens! (Bond Level ${player.bondedSpirit.bondLevel})`);
                            if (spiritData.bondMessages[player.bondedSpirit.bondLevel -1]) { 
                                 UIManager.logEvent(spiritData.bondMessages[player.bondedSpirit.bondLevel -1]);
                            }
                        }
                    }
                }

                ActionHandler.checkElementalSpiritEncounter(); 

                UIManager.updateUI(); 
                if (!eventInProgress) { 
                    UIManager.logEvent(`Year ${player.currentDate.year} begins. You are now ${player.age}.`);
                }
                this.save(); 
            },
            save: function() {
                localStorage.setItem(SAVE_KEY, JSON.stringify(player));
            },
            load: function() {
                const savedData = localStorage.getItem(SAVE_KEY);
                if (savedData) {
                    return JSON.parse(savedData);
                }
                return null;
            },
            endGame: function(finalDeathMessage = "Your journey has come to an end.") {
                gameEnded = true;
                UIManager.logEvent(finalDeathMessage); 
                player.deathMessages.push({ date: new Date().toLocaleString(), message: finalDeathMessage });
                this.save(); 

                UIManager.showGameOverScreen(finalDeathMessage);
                
                advanceYearButtonUI.disabled = true;
                saveGameButtonUI.disabled = true;
                itemBagButtonUI.disabled = true;
                manageCompanionsButtonUI.disabled = true;
                actionsContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);
                if (player.inDungeon) { 
                    dungeonInterface.classList.add('hidden');
                    worldActionsContainer.classList.remove('hidden'); 
                }
            },
            calculatePowerScore: function() {
                let score = 0;
                const stats = player.effectiveStats; 
                for (const stat in stats) {
                    if (typeof stats[stat] === 'number' && stat !== 'MANA' && stat !== 'MaxMana') { 
                        score += stats[stat];
                    }
                }
                score += Math.floor((player.maxMana || 0) / 10); 
                return Math.floor(score);
            },
            checkRankUp: function() {
                const currentRankIndex = RANKS.indexOf(player.rank);
                if (currentRankIndex < RANKS.length - 1) { 
                    const nextRankKey = RANKS[currentRankIndex + 1];
                    const requirements = RANK_REQUIREMENTS[nextRankKey];
                    if (player.rankXP >= requirements.xp && player.powerScore >= requirements.powerScore) {
                        player.rank = nextRankKey;
                        player.maxHP += 15 + Math.floor((player.baseStats.CON || 0) * 0.5); 
                        player.currentHP = player.maxHP; 
                        UIManager.logEvent(`🎉 RANK UP! You have been promoted to <span class="font-bold text-purple-300">${player.rank} Rank</span>! Your HP increased!`);
                        UIManager.showMessageModal("Rank Up!", `Congratulations! You've been promoted to ${player.rank} Rank!`);
                    }
                }
            },
            calculateEffectiveStats: function() { 
                const effective = { ...player.baseStats };
                for (const slot in player.equipment) {
                    const item = player.equipment[slot];
                    if (item && item.stats) {
                        for (const stat in item.stats) {
                            effective[stat.toUpperCase()] = (effective[stat.toUpperCase()] || 0) + item.stats[stat];
                        }
                    }
                }
                if (player.bondedSpirit) {
                    const spiritData = gameData.elementalSpirits.find(s => s.id === player.bondedSpirit.id);
                    if (spiritData) {
                        for (const stat in spiritData.baseBoosts) {
                            effective[stat.toUpperCase()] = (effective[stat.toUpperCase()] || 0) + spiritData.baseBoosts[stat];
                        }
                        if (player.bondedSpirit.bondLevel > 1) {
                            for (const stat in spiritData.boostPerLevel) {
                                effective[stat.toUpperCase()] = (effective[stat.toUpperCase()] || 0) + (spiritData.boostPerLevel[stat] * (player.bondedSpirit.bondLevel - 1));
                            }
                        }
                    }
                }
                
                let newMaxMana = (effective.INT || 0) * 5 + (player.class.baseStats.MANA || 100);
                for (const slot in player.equipment) {
                    const item = player.equipment[slot];
                    if (item && item.stats && item.stats.MANA) {
                        newMaxMana += item.stats.MANA;
                    }
                }
                 if (player.bondedSpirit) {
                    const spiritData = gameData.elementalSpirits.find(s => s.id === player.bondedSpirit.id);
                    if (spiritData) {
                        if(spiritData.baseBoosts.MANA) newMaxMana += spiritData.baseBoosts.MANA;
                        if (player.bondedSpirit.bondLevel > 1 && spiritData.boostPerLevel.MANA) {
                             newMaxMana += (spiritData.boostPerLevel.MANA * (player.bondedSpirit.bondLevel - 1));
                        }
                    }
                }
                player.maxMana = newMaxMana;
                player.mana = Math.min(player.mana, player.maxMana);
                return effective;
            }
        };
        window.GameManager = GameManager; 

        // --- UIManager Module ---
        const UIManager = {
            updateUI: function() {
                player.powerScore = GameManager.calculatePowerScore(); 
                this.updateCharacterSheet();
                this.updateWorldActions();
            },
            updateCharacterSheet: function() {
                charDate.innerHTML = `<strong>Date:</strong> Year ${player.currentDate.year}, Month ${player.currentDate.month}, Day ${player.currentDate.day}`;
                charName.innerHTML = `<strong>Name:</strong> <span class="stat-value">${player.name}</span>`;
                charAge.innerHTML = `<strong>Age:</strong> <span class="stat-value">${player.age}</span>`;
                charGold.innerHTML = `<strong>Gold:</strong> <span class="gold-value">${player.gold} G</span>`;
                charWorld.innerHTML = `<strong>World:</strong> <span class="stat-value">${player.world.name}</span>`;
                charRank.innerHTML = `<strong>Rank:</strong> <span class="stat-value">${player.rank}</span>`;
                charPowerScore.innerHTML = `<strong>Power Score:</strong> <span class="stat-value">${player.powerScore}</span>
                    <div class="progress-bar-container"><div class="progress-bar power-bar" style="width: ${Math.min(100, (player.powerScore / (RANK_REQUIREMENTS[RANKS[RANKS.indexOf(player.rank) + 1]]?.powerScore || player.powerScore + 1)) * 100) || 0}%"></div></div>`;

                charHP.innerHTML = `<strong>HP:</strong> <span class="stat-value">${player.currentHP}/${player.maxHP}</span>
                    <div class="progress-bar-container"><div class="progress-bar hp-bar" style="width: ${player.maxHP > 0 ? (player.currentHP / player.maxHP) * 100 : 0}%"></div></div>`;
                
                charStamina.innerHTML = `<strong>Stamina:</strong> <span class="stat-value">${player.stamina}/${player.maxStamina}</span>
                    <div class="progress-bar-container"><div class="progress-bar stamina-bar" style="width: ${player.maxStamina > 0 ? (player.stamina / player.maxStamina) * 100 : 0}%"></div></div>`;

                const nextRankData = RANK_REQUIREMENTS[RANKS[RANKS.indexOf(player.rank) + 1]];
                const nextRankXP = nextRankData?.xp;
                charRankXP.innerHTML = `<strong>Rank XP:</strong> <span class="stat-value">${player.rankXP}/${nextRankXP || 'MAX'}</span>
                    <div class="progress-bar-container"><div class="progress-bar xp-bar" style="width: ${((player.rankXP / (nextRankXP || player.rankXP + 1)) * 100) || (player.rank === "SSS" ? 100: 0)}%"></div></div>`;
                charClass.innerHTML = `<strong>Class:</strong> <span class="stat-value">${player.class.name}</span>`;
                
                if (player.bondedSpirit) {
                    const spiritData = gameData.elementalSpirits.find(s => s.id === player.bondedSpirit.id);
                    charElementalSpirit.innerHTML = `<strong>Spirit:</strong> <span class="stat-value text-cyan-300">${spiritData.name} (Bond Lvl: ${player.bondedSpirit.bondLevel})</span>`;
                } else {
                    charElementalSpirit.innerHTML = `<strong>Spirit:</strong> <span class="stat-value">None</span>`;
                }

                charCompanionsList.innerHTML = ''; 
                if (player.companions && player.companions.length > 0) {
                    player.companions.forEach(comp => {
                        const compDiv = document.createElement('div');
                        compDiv.classList.add('companion-entry');
                        let typeDisplay = comp.type === "Romantic" ? "Romantic Partner" : "Friend";
                        compDiv.innerHTML = `
                            <div><span class="companion-name">${comp.name}</span> (<span class="companion-type">${typeDisplay}</span>)</div>
                            <div>Bond Level: <span class="stat-value">${comp.level}/100</span></div>
                            <div class="progress-bar-container"><div class="progress-bar relationship-bar" style="width: ${comp.level}%"></div></div>
                        `;
                        charCompanionsList.appendChild(compDiv);
                    });
                } else {
                    charCompanionsList.innerHTML = '<div><span class="stat-value">None</span></div>';
                }

                charChildren.innerHTML = `<strong>Children:</strong> <span class="stat-value">${player.children.length > 0 ? player.children.join(', ') : 'None'}</span>`;

                let baseStatsHtml = '';
                for (const stat in player.baseStats) {
                    baseStatsHtml += `<div>${stat.toUpperCase()}: <span class="stat-value">${player.baseStats[stat]}</span></div>`;
                }
                charBaseStats.innerHTML = baseStatsHtml;

                player.effectiveStats = GameManager.calculateEffectiveStats(); 
                let effectiveStatsHtml = '';
                for (const stat in player.effectiveStats) {
                    if (stat.toLowerCase() === 'maxmana' && player.effectiveStats['MANA'] !== undefined) continue;
                    if (stat.toLowerCase() === 'mana') {
                         effectiveStatsHtml += `<div>MANA: <span class="stat-value">${player.mana}/${player.maxMana}</span></div>`;
                    } else {
                        effectiveStatsHtml += `<div>${stat.toUpperCase()}: <span class="stat-value">${player.effectiveStats[stat]}</span></div>`;
                    }
                }
                charEffectiveStats.innerHTML = effectiveStatsHtml;

                charAccolades.innerHTML = player.accolades.map(accId => {
                    const accoladeData = gameData.accolades.find(a => a.id === accId);
                    return `<span class="accolade-name" data-type="accolade" data-id="${accId}">${accoladeData ? accoladeData.name : accId}</span>`;
                }).join(', ') || 'None';

                charTitles.innerHTML = player.titles.length > 0 ? player.titles.map(t => `<span class="title-name">${t}</span>`).join(', ') : 'None'; 

                charBlessings.innerHTML = player.blessings.map(blessId => {
                     const blessingData = gameData.blessings.find(b => b.id === blessId);
                     return `<span class="blessing-name" data-type="blessing" data-id="${blessId}">${blessingData ? blessingData.name : blessId}</span>`;
                }).join(', ') || 'None';

                charCurses.innerHTML = player.curses.map(curseId => {
                    const curseData = gameData.curses.find(c => c.id === curseId);
                    return `<span class="curse-name" data-type="curse" data-id="${curseId}">${curseData ? curseData.name : curseId}</span>`;
                }).join(', ') || 'None';


                let equipmentHtml = '';
                for (const slot in player.equipment) {
                    const item = player.equipment[slot];
                    equipmentHtml += `<div>${slot.charAt(0).toUpperCase() + slot.slice(1)}: <span class="item-name ${item && item.rarity ? ITEM_RARITIES[item.rarity]?.color || 'text-gray-300' : 'text-gray-300'}">${item ? item.name : 'None'}</span></div>`;
                }
                charEquipment.innerHTML = equipmentHtml;

                charTreasures.innerHTML = player.treasures.length > 0 ? player.treasures.map(t => `<span class="item-name">${t}</span>`).join(', ') : 'None';
                
                document.querySelectorAll('.accolade-name, .blessing-name, .curse-name').forEach(el => {
                    el.removeEventListener('click', this.showDescriptionModal); 
                    el.addEventListener('click', this.showDescriptionModal);
                });
            },
            showDescriptionModal: function(event) {
                const type = event.target.dataset.type;
                const id = event.target.dataset.id;
                let dataSet;
                switch(type) {
                    case 'accolade': dataSet = gameData.accolades; break;
                    case 'blessing': dataSet = gameData.blessings; break;
                    case 'curse': dataSet = gameData.curses; break;
                    default: return;
                }
                const item = dataSet.find(d => d.id === id);
                if (item) {
                    UIManager.showMessageModal(item.name, item.description || "No description available.");
                }
            },
            updateWorldActions: function() {
                actionsContainer.innerHTML = ''; 
                
                const createButton = (action, isWorldSpecific = false) => {
                    const button = document.createElement('button');
                    button.classList.add('btn');
                    if (isWorldSpecific) {
                        button.classList.add('btn-world');
                    } else if (action.buttonClass) {
                        button.classList.add(action.buttonClass);
                    } else {
                        button.classList.add('btn-action');
                    }
                    button.textContent = `${action.name} (${action.timeCost} Days)`;
                    
                    if (action.staminaCost && player.stamina < action.staminaCost) {
                        button.classList.add('opacity-50', 'cursor-not-allowed');
                        button.disabled = true;
                        button.title = `Requires ${action.staminaCost} stamina. You have ${player.stamina}.`;
                    } else {
                        button.addEventListener('click', () => ActionHandler.performAction(action.id));
                    }
                    return button;
                };
                
                const createLockedButton = (action, requirementText) => {
                    const button = document.createElement('button');
                    button.classList.add('btn', 'btn-world', 'opacity-50', 'cursor-not-allowed');
                    button.textContent = `${action.name} (${action.timeCost} Days, Locked)`;
                    button.title = `Requires: ${requirementText.join(', ')}`;
                    return button;
                };

                const genericActions = [
                    {id: 'study', name: 'Study', timeCost: 3, buttonClass: 'btn-action', staminaGain: 5},
                    {id: 'train', name: 'Train', timeCost: 3, buttonClass: 'btn-action', staminaCost: 15},
                    {id: 'socialize', name: 'Socialize', timeCost: 2, buttonClass: 'btn-action', staminaGain: 2},
                    {id: 'meditate', name: 'Meditate', timeCost: 2, buttonClass: 'btn-action', staminaGain: 10},
                    {id: 'adventure', name: 'Go on an Adventure', timeCost: 5, buttonClass: 'btn-action', staminaCost: 20},
                ];
                genericActions.forEach(action => actionsContainer.appendChild(createButton(action)));


                gameData.ageSpecificActions.forEach(action => {
                    if (player.age >= action.ageMin && (action.ageMax === undefined || player.age <= action.ageMax)) {
                         // Special check for early certification
                        if (action.id === 'early_certification' && player.isCertifiedAdventurer) return;
                        actionsContainer.appendChild(createButton(action));
                    }
                });
                
                gameData.utilityActions.forEach(action => {
                     if (action.id === 'seek_companion' && player.companions.length >= MAX_COMPANIONS) return; 
                     if (action.id === 'confess_feelings') {
                         const eligibleFriends = player.companions.filter(c => c.type === 'Friend' && player.age >= MIN_ROMANCE_AGE && c.level >= FRIENDSHIP_TO_ROMANCE_THRESHOLD);
                         if (eligibleFriends.length > 0 && !player.companions.find(c => c.type === "Romantic")) { 
                             const confessButton = createButton(action);
                             confessButton.textContent = `${action.name} to ${eligibleFriends[0].name} (${action.timeCost} Days)`;
                             actionsContainer.appendChild(confessButton);
                         }
                         return; 
                     }
                     if (action.id === 'visit_guild_hall' && !player.isCertifiedAdventurer) return; // Only show if certified

                     if (action.ageMin === undefined || player.age >= action.ageMin) {
                        actionsContainer.appendChild(createButton(action));
                    }
                });


                if (player.world && player.world.lateGameActions) {
                    player.world.lateGameActions.forEach(action => {
                        if (player.completedWorldEvents.includes(action.id) && action.unique) return; 

                        if (RANKS.indexOf(player.rank) >= RANKS.indexOf(action.rankReq)) {
                            let requirementsMet = true;
                            if (action.requiresStats) {
                                for (const stat in action.requiresStats) {
                                    if ((player.effectiveStats[stat.toUpperCase()] || 0) < action.requiresStats[stat]) {
                                        requirementsMet = false;
                                        break;
                                    }
                                }
                            }
                            if (requirementsMet) {
                                 actionsContainer.appendChild(createButton(action, true));
                            } else {
                                let requirementText = [];
                                for (const stat in action.requiresStats) {
                                    requirementText.push(`${stat.toUpperCase()}: ${action.requiresStats[stat]}`);
                                }
                                actionsContainer.appendChild(createLockedButton(action, requirementText));
                            }
                        }
                    });
                }
                if (player.deathMessages && player.deathMessages.length > 0) {
                    viewPastDeathsButtonUI.classList.remove('hidden');
                } else {
                    viewPastDeathsButtonUI.classList.add('hidden');
                }
            },
            displayOccupationSelection: function() {
                initialLoadPrompt.classList.add('hidden');
                occupationSelection.classList.remove('hidden');
                occupationSelection.innerHTML = `<h2 class="text-xl md:text-2xl mb-3 text-center title-font">In your past life, you were a...</h2>`;
                gameData.occupations.forEach(occ => {
                    const button = document.createElement('button');
                    button.classList.add('btn', 'btn-primary', 'm-1');
                    button.textContent = occ.name;
                    button.addEventListener('click', () => ActionHandler.selectOccupation(occ.name));
                    occupationSelection.appendChild(button);
                });
            },
            displayClassSelection: function() {
                classSelection.classList.remove('hidden');
                classSelectionTitle.textContent = `The Goddess Offers You a Path, ${player.occupation.name} from another world...`;
                classSelectionIntro.textContent = "Choose a class that resonates with your new destiny:";
                classChoicesContainer.innerHTML = ''; 
                player.occupation.classChoices.forEach(cls => {
                    const card = document.createElement('div');
                    card.classList.add('class-choice-card');
                    card.innerHTML = `
                        <h4 class="font-bold">${cls.name}</h4>
                        <p>${cls.description}</p>
                        <p class="text-sm text-gray-400">Starting Stats: STR:${cls.baseStats.STR} DEX:${cls.baseStats.DEX} CON:${cls.baseStats.CON} INT:${cls.baseStats.INT} WIS:${cls.baseStats.WIS} CHA:${cls.baseStats.CHA} LUCK:${cls.baseStats.LUCK} MANA:${cls.baseStats.MANA}</p>
                        <p class="text-sm text-gray-400">Starting Equipment: ${cls.equipment.map(item => item.name).join(', ')}</p>
                        <p class="text-sm text-gray-400">Blessings: ${cls.blessings.map(b => gameData.blessings.find(bd => bd.id === b.id)?.name || b.id).join(', ')}</p>
                        <p class="text-sm text-gray-400">Curses: ${cls.curses.map(c => gameData.curses.find(cd => cd.id === c.id)?.name || c.id).join(', ')}</p>
                    `;
                    card.addEventListener('click', () => ActionHandler.selectClass(cls.name));
                    classChoicesContainer.appendChild(card);
                });
            },
            showNewLifeInterface: function() {
                newLifeInterface.classList.remove('hidden');
                gameOverScreen.classList.add('hidden'); 
                occupationSelection.classList.add('hidden');
                classSelection.classList.add('hidden');
                advanceYearButtonUI.disabled = false;
                saveGameButtonUI.disabled = false;
                itemBagButtonUI.disabled = false;
                manageCompanionsButtonUI.disabled = false;
            },
            logEvent: function(message) {
                const logEntry = document.createElement('div');
                logEntry.classList.add('log-entry');
                logEntry.innerHTML = `[Y${player.currentDate.year} M${player.currentDate.month} D${player.currentDate.day} Age:${player.age}] ${message}`;
                eventLog.prepend(logEntry); 
                if (eventLog.children.length > 100) { 
                    eventLog.removeChild(eventLog.lastChild);
                }
            },
            showMessageModal: function(title, message) {
                modalTitle.textContent = title;
                modalMessageText.innerHTML = message; 
                messageModal.classList.remove('hidden');
            },
            showEvent: function(actionId, message, isGameEnd = false, isSignificant = false) {
                eventTitleElem.textContent = "Event Occurred"; 
                eventTextElem.innerHTML = message;
                
                if (isSignificant || isGameEnd) { 
                    eventDisplay.classList.remove('hidden');
                    newLifeInterface.classList.add('hidden');
                } else { 
                    this.logEvent(message.replace(/<[^>]*>?/gm, '')); 
                    eventInProgress = false;
                    this.updateUI();
                    return;
                }

                continueButtonElem.onclick = () => {
                    eventDisplay.classList.add('hidden');
                    if (!isGameEnd) { 
                        newLifeInterface.classList.remove('hidden');
                    }
                    eventInProgress = false; 
                    if (isGameEnd) {
                        GameManager.endGame(message); 
                    } else {
                        this.updateUI(); 
                    }
                };
            },
            showGameOverScreen: function(finalDeathMessage) {
                newLifeInterface.classList.add('hidden');
                eventDisplay.classList.add('hidden');
                gameOverScreen.classList.remove('hidden');
                finalDeathMessageElem.innerHTML = finalDeathMessage;
            },
            hideGameOverScreen: function() {
                gameOverScreen.classList.add('hidden');
            },
            showDungeonInterface: function(dungeonAction) {
                worldActionsContainer.classList.add('hidden');
                dungeonInterface.classList.remove('hidden');
                dungeonNameElem.textContent = `Exploring: ${dungeonAction.name}`;
                this.updateDungeonStatus();
            },
            updateDungeonStatus: function() {
                if (!player.inDungeon) return;
                dungeonStatusElem.innerHTML = `<strong>Turns Left:</strong> <span class="stat-value">${player.inDungeon.turnsLeft}</span>
                    <div class="progress-bar-container"><div class="progress-bar dungeon-time-bar" style="width: ${(player.inDungeon.turnsLeft / currentDungeon.timeCost) * 100}%"></div></div>
                    <div class="mt-1"><strong>Current HP:</strong> <span class="stat-value">${player.currentHP}/${player.maxHP}</span></div>
                `;
            },
            openItemBag: function() {
                if (eventInProgress || gameEnded) return;
                itemBagContent.innerHTML = ''; 
                if (player.inventory.length === 0) {
                    itemBagContent.innerHTML = '<p class="text-center text-gray-400">Your bag is empty.</p>';
                } else {
                    player.inventory.forEach((item, index) => {
                        const itemDiv = document.createElement('div');
                        itemDiv.classList.add('item-slot');
                        let tooltipText = ``;
                        let statSummary = "";

                        if (item.stats && Object.keys(item.stats).length > 0) {
                            tooltipText += `Stats: ${Object.entries(item.stats).map(([stat, value]) => `${stat.toUpperCase()}: ${value}`).join(', ')}`;
                            statSummary = `(${Object.entries(item.stats).map(([s,v]) => `${s.slice(0,3).toUpperCase()}+${v}`).join(', ')})`;
                        } else if (item.effect && item.effect.heal) {
                            tooltipText = `Effect: Heals ${item.effect.heal} HP`;
                            statSummary = `(Heal ${item.effect.heal})`;
                        } else if (item.effect && item.effect.mana) {
                            tooltipText = `Effect: Restores ${item.effect.mana} Mana`;
                             statSummary = `(Mana ${item.effect.mana})`;
                        } else if (item.type === 'material') {
                            tooltipText = `Material. Sell value: ${item.sellPrice || item.baseSellValue || 1}G`;
                            statSummary = `(Material)`;
                        }
                         else {
                            tooltipText += `Stats: None`;
                        }
                        const rarityColor = ITEM_RARITIES[item.rarity]?.color || 'text-gray-300';

                        itemDiv.innerHTML = `<div class="item-name-container"><span class="item-name ${rarityColor}">${item.name}</span><span class="item-stat-summary">${statSummary}</span> (${item.type})</div>
                                            ${item.type !== 'consumable' && item.type !== 'material' ? `<button class="btn btn-equip" data-index="${index}">Equip</button>` : ''}
                                            ${item.type === 'consumable' ? `<button class="btn btn-info" data-index="${index}">Use</button>` : ''}
                                            <div class="item-tooltip hidden">${tooltipText}</div>`; 
                        itemBagContent.appendChild(itemDiv);
                        
                        const actionButton = itemDiv.querySelector('.btn-equip, .btn-info');
                        if (actionButton) {
                            actionButton.addEventListener('click', (e) => {
                                const itemIndex = parseInt(e.target.dataset.index);
                                if (item.type !== 'consumable' && item.type !== 'material') {
                                    ActionHandler.equipItem(itemIndex);
                                } else if (item.type === 'consumable') {
                                    ActionHandler.useConsumableItem(itemIndex);
                                }
                            });
                        }
                    });
                }
                itemBagModal.classList.remove('hidden');
            },
            closeItemBag: function() {
                itemBagModal.classList.add('hidden');
            },
            openShopModal: function() {
                shopPlayerGoldElem.textContent = player.gold;
                this.switchShopTab('buy'); 
                shopModal.classList.remove('hidden');
            },
            closeShopModal: function() { 
                shopModal.classList.add('hidden');
                eventInProgress = false; 
                this.updateUI(); 
            },
            switchShopTab: function(tab) {
                const buyContent = document.getElementById('shopInventory');
                const sellContent = document.getElementById('sellInterface');
                const buyTabElem = document.getElementById('buyTab');
                const sellTabElem = document.getElementById('sellTab');

                if (tab === 'buy') {
                    buyContent.classList.remove('hidden');
                    sellContent.classList.add('hidden');
                    buyTabElem.classList.add('active');
                    sellTabElem.classList.remove('active');
                    this.populateShopBuyList(); 
                } else if (tab === 'sell') {
                    buyContent.classList.add('hidden');
                    sellContent.classList.remove('hidden');
                    buyTabElem.classList.remove('active');
                    sellTabElem.classList.add('active');
                    this.populateShopSellList(); 
                }
            },
            populateShopBuyList: function() {
                shopInventoryElem.innerHTML = ''; 
                let currentShopStock = [...gameData.shopItems]; 
                for(let i = 0; i < 3; i++) { 
                    currentShopStock.push(ItemSystem.generateRandomItem());
                }

                currentShopStock.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.classList.add('shop-item-slot');
                    
                    let tooltipText = item.description || "A standard shop item.";
                    if (item.stats && Object.keys(item.stats).length > 0) {
                         tooltipText += ` Stats: ${Object.entries(item.stats).map(([s,v]) => `${s.toUpperCase()}: ${v}`).join(', ')}`;
                    } else if (item.effect && item.effect.heal) {
                        tooltipText += ` Effect: Heals ${item.effect.heal} HP.`;
                    } else if (item.effect && item.effect.mana) {
                        tooltipText += ` Effect: Restores ${item.effect.mana} Mana.`;
                    }
                    const rarityColor = ITEM_RARITIES[item.rarity]?.color || 'text-gray-300';

                    itemDiv.innerHTML = `
                        <span class="item-name-container"><span class="item-name ${rarityColor}">${item.name}</span> (${item.type})</span>
                        <span class="shop-item-cost">${item.cost}G</span>
                        <button class="btn btn-buy" data-itemid="${item.id || item.name}" ${player.gold < item.cost ? 'disabled' : ''}>Buy</button>
                        <div class="item-tooltip hidden">${tooltipText}</div>
                    `;
                    shopInventoryElem.appendChild(itemDiv);

                    itemDiv.querySelector('.btn-buy').addEventListener('click', (e) => {
                        const boughtItem = currentShopStock.find(i => (i.id && i.id.toString() === e.target.dataset.itemid) || i.name === e.target.dataset.itemid);
                        if (boughtItem) ActionHandler.buyShopItem(boughtItem);
                    });
                });
            },
            populateShopSellList: function() {
                sellInterfaceElem.innerHTML = '';
                if (player.inventory.length === 0) {
                    sellInterfaceElem.innerHTML = '<p class="text-center text-gray-400">Your bag is empty.</p>';
                    return;
                }
                player.inventory.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.classList.add('sell-item-slot');
                    const sellPrice = item.sellPrice || Math.max(1, Math.floor((item.cost || item.baseSellValue || 0) * 0.3)); 
                    const rarityColor = ITEM_RARITIES[item.rarity]?.color || 'text-gray-300';

                    let tooltipText = `Stats: `;
                     if (item.stats && Object.keys(item.stats).length > 0) {
                        tooltipText += Object.entries(item.stats).map(([stat, value]) => `${stat.toUpperCase()}: ${value}`).join(', ');
                    } else if (item.effect && item.effect.heal) {
                        tooltipText = `Effect: Heals ${item.effect.heal} HP`;
                    } else if (item.effect && item.effect.mana) {
                        tooltipText = `Effect: Restores ${item.effect.mana} Mana`;
                    } else if (item.type === 'material') {
                         tooltipText = `Material. Base value: ${item.baseSellValue || 1}G`;
                    }
                     else {
                        tooltipText += `None`;
                    }

                    itemDiv.innerHTML = `
                        <span class="item-name-container"><span class="item-name ${rarityColor}">${item.name}</span> (${item.type})</span>
                        <span class="sell-item-price">Sell: ${sellPrice}G</span>
                        <button class="btn btn-sell" data-index="${index}">Sell</button>
                        <div class="item-tooltip hidden">${tooltipText}</div>
                    `;
                    sellInterfaceElem.appendChild(itemDiv);
                    itemDiv.querySelector('.btn-sell').addEventListener('click', (e) => {
                        ActionHandler.sellPlayerItem(parseInt(e.target.dataset.index));
                    });
                });
            },
            openManageCompanionsModal: function() {
                manageCompanionsContent.innerHTML = '';
                const friends = player.companions.filter(c => c.type === "Friend");
                if (friends.length === 0 && player.companions.length >= MAX_COMPANIONS) {
                     manageCompanionsContent.innerHTML = '<p class="text-center text-gray-400">You have no friends to part ways with, and your social circle is full.</p>';
                } else if (friends.length === 0) {
                    manageCompanionsContent.innerHTML = '<p class="text-center text-gray-400">You have no friends to manage currently.</p>';
                }
                 else {
                    friends.forEach(friend => {
                        const friendDiv = document.createElement('div');
                        friendDiv.classList.add('companion-manage-slot');
                        friendDiv.innerHTML = `
                            <span class="companion-name-container"><span class="companion-name">${friend.name}</span> (Friend - Level: ${friend.level})</span>
                            <button class="btn btn-part-ways" data-companionid="${friend.id}">Part Ways</button>
                        `;
                        manageCompanionsContent.appendChild(friendDiv);
                        friendDiv.querySelector('.btn-part-ways').addEventListener('click', (e) => {
                            ActionHandler.partWaysWithFriend(e.target.dataset.companionid);
                        });
                    });
                }
                manageCompanionsModal.classList.remove('hidden');
            },
            closeManageCompanionsModal: function() {
                manageCompanionsModal.classList.add('hidden');
            },
            openDeathMessagesModal: function() {
                deathMessagesContent.innerHTML = '';
                if (player.deathMessages && player.deathMessages.length > 0) {
                    player.deathMessages.slice().reverse().forEach(death => { 
                        const deathDiv = document.createElement('div');
                        deathDiv.classList.add('death-message-entry', 'text-sm', 'text-gray-300');
                        deathDiv.innerHTML = `<strong>${death.date || 'Earlier Time'}:</strong> ${death.message}`;
                        deathMessagesContent.appendChild(deathDiv);
                    });
                } else {
                    deathMessagesContent.innerHTML = '<p class="text-center text-gray-400">No past demises recorded.</p>';
                }
                deathMessagesModal.classList.remove('hidden');
            },
            closeDeathMessagesModal: function() {
                deathMessagesModal.classList.add('hidden');
            },
            openGuildHallModal: function() {
                guildQuestsContent.innerHTML = '';
                if (player.activeGuildQuest) {
                    activeQuestTitle.textContent = player.activeGuildQuest.title;
                    activeQuestDescription.textContent = player.activeGuildQuest.description;
                    activeGuildQuestDisplay.classList.remove('hidden');
                    guildQuestsContent.classList.add('hidden'); // Hide quest list when one is active
                } else {
                    activeGuildQuestDisplay.classList.add('hidden');
                    guildQuestsContent.classList.remove('hidden');
                    const availableQuests = gameData.guildQuests.filter(q => {
                        let meetsReq = true;
                        if (q.worldId && q.worldId !== player.world.id) meetsReq = false;
                        if (q.rankReq && RANKS.indexOf(player.rank) < RANKS.indexOf(q.rankReq)) meetsReq = false;
                        // Add other conditions like completed prereqs here if needed
                        return meetsReq;
                    });

                    if (availableQuests.length === 0) {
                        guildQuestsContent.innerHTML = '<p class="text-center text-gray-400">No quests available for your rank or current world.</p>';
                    } else {
                        availableQuests.forEach(quest => {
                            const questDiv = document.createElement('div');
                            questDiv.classList.add('quest-entry');
                            questDiv.innerHTML = `
                                <h5 class="font-semibold">${quest.title} (${quest.type})</h5>
                                <p class="text-xs">${quest.description}</p>
                                <p class="text-xs">Location: ${quest.location} | Reward: ${quest.rewards.gold}G, ${quest.rewards.xp}XP</p>
                                <button class="btn btn-action btn-sm" data-questid="${quest.id}">Accept Quest</button>
                            `;
                            guildQuestsContent.appendChild(questDiv);
                            questDiv.querySelector('button').addEventListener('click', (e) => ActionHandler.acceptGuildQuest(e.target.dataset.questid));
                        });
                    }
                }
                guildHallModal.classList.remove('hidden');
            },
            closeGuildHallModal: function() {
                guildHallModal.classList.add('hidden');
                eventInProgress = false;
                UIManager.updateUI();
            }
        };
        window.UIManager = UIManager; 

        // --- ActionHandler Module ---
        const ActionHandler = {
            selectOccupation: function(occupationName) {
                player.occupation = gameData.occupations.find(occ => occ.name === occupationName);
                occupationSelection.classList.add('hidden');
                UIManager.displayClassSelection();
            },
            selectClass: function(className) {
                player.class = player.occupation.classChoices.find(cls => cls.name === className);
                player.baseStats = { ...player.class.baseStats };
                player.mana = player.class.baseStats.MANA;
                player.maxMana = player.class.baseStats.MANA;
                player.blessings = player.class.blessings.map(b => b.id); 
                player.curses = player.class.curses.map(c => c.id);     
                player.equipment = { weapon: null, armor: null, misc: null };
                player.class.equipment.forEach(item => {
                    const itemSlot = item.slot || item.type; 
                    if (itemSlot === 'weapon' && !player.equipment.weapon) player.equipment.weapon = {...item};
                    else if (itemSlot === 'armor' && !player.equipment.armor) player.equipment.armor = {...item};
                    else if (itemSlot === 'misc' && !player.equipment.misc) player.equipment.misc = {...item};
                    else player.inventory.push({...item}); 
                });
                player.world = gameData.worlds[Math.floor(Math.random() * gameData.worlds.length)];
                classSelection.classList.add('hidden');
                UIManager.showNewLifeInterface();
                UIManager.logEvent(`You have been reborn as a <span class="font-bold text-blue-300">${player.class.name}</span> in <span class="font-bold text-yellow-300">${player.world.name}</span>!`);
                UIManager.logEvent(player.world.description);
                UIManager.updateUI();
            },
            performAction: function(actionId) {
                if (eventInProgress || gameEnded) {
                    console.warn(`Action '${actionId}' blocked: eventInProgress=${eventInProgress}, gameEnded=${gameEnded}`);
                    return;
                }
                eventInProgress = true;

                let actionDefinition = gameData.ageSpecificActions.find(a => a.id === actionId) ||
                                       gameData.utilityActions.find(a => a.id === actionId) ||
                                       (player.world.lateGameActions && player.world.lateGameActions.find(a => a.id === actionId));
                
                if (!actionDefinition) {
                    switch (actionId) { 
                        case 'study': actionDefinition = { id: 'study', name: 'Study', timeCost: 3, staminaGain: 5, effects: {INT:0, WIS:0, XP:0}, result: ""}; break;
                        case 'train': actionDefinition = { id: 'train', name: 'Train', timeCost: 3, staminaCost: 15, effects: {STR:0, DEX:0, CON:0, XP:0}, result: "" }; break;
                        case 'socialize': actionDefinition = { id: 'socialize', name: 'Socialize', timeCost: 2, staminaGain: 2, effects: {CHA:0, XP:0}, result: "" }; break;
                        case 'meditate': actionDefinition = { id: 'meditate', name: 'Meditate', timeCost: 2, staminaGain: 10, effects: {MANA:0, WIS:0, XP:0}, result: "" }; break;
                        case 'adventure': actionDefinition = { id: 'adventure', name: 'Go on an Adventure', timeCost: 5, staminaCost: 20, effects: {XP:0}, result: "" }; break;
                    }
                }
                
                if (!actionDefinition) {
                    UIManager.logEvent(`Error: Action ID "${actionId}" not found.`);
                    eventInProgress = false; 
                    return;
                }
                
                try {
                    if (actionDefinition.unique && player.completedWorldEvents.includes(actionId)) {
                        UIManager.logEvent(`You have already completed ${actionDefinition.name}.`);
                        eventInProgress = false;
                        return;
                    }

                    if (actionDefinition.staminaCost && player.stamina < actionDefinition.staminaCost) {
                        UIManager.logEvent(`You are too exhausted to ${actionDefinition.name.toLowerCase()}. You need ${actionDefinition.staminaCost} stamina, but only have ${player.stamina}.`);
                        // UIManager.showMessageModal("Too Exhausted!", `You need to rest before attempting to ${actionDefinition.name.toLowerCase()}.`); // Replaced by button disabling
                        eventInProgress = false;
                        return;
                    }
                    if (actionDefinition.requiresCertification && !player.isCertifiedAdventurer) {
                        UIManager.logEvent(`You must be a certified adventurer to ${actionDefinition.name.toLowerCase()}.`);
                        UIManager.showMessageModal("Certification Required", `You need to become a certified adventurer first.`);
                        eventInProgress = false;
                        return;
                    }


                    let resultText = actionDefinition.result || "";
                    let hpChange = 0;
                    let xpGain = 0;
                    let manaChange = 0;
                    let statChanges = {};
                    let relationshipLevelChange = 0;
                    let titleGranted = null;
                    let accoladeGranted = null;
                    let itemGained = null; 
                    let isBattle = actionDefinition.isBattle || false;
                    let isGameEnd = actionDefinition.isGameEnd || false;
                    let isSignificantEvent = actionDefinition.significantEvent || false;
                    let goldChange = 0;

                    if (actionDefinition.goldCost && player.gold < actionDefinition.goldCost) {
                        UIManager.logEvent(`Not enough gold for ${actionDefinition.name}. You need ${actionDefinition.goldCost}G.`);
                        eventInProgress = false;
                        UIManager.updateUI(); 
                        return;
                    }
                    if(actionDefinition.goldCost) goldChange -= actionDefinition.goldCost;

                    const effectiveStats = player.effectiveStats; 

                    if (actionDefinition.effects) {
                        if(actionDefinition.effects.XP) xpGain += actionDefinition.effects.XP;
                        if(actionDefinition.effects.GOLD) goldChange += actionDefinition.effects.GOLD;
                        if(actionDefinition.effects.STR) statChanges.STR = (statChanges.STR || 0) + actionDefinition.effects.STR;
                        if(actionDefinition.effects.DEX) statChanges.DEX = (statChanges.DEX || 0) + actionDefinition.effects.DEX;
                        if(actionDefinition.effects.CON) statChanges.CON = (statChanges.CON || 0) + actionDefinition.effects.CON;
                        if(actionDefinition.effects.INT) statChanges.INT = (statChanges.INT || 0) + actionDefinition.effects.INT;
                        if(actionDefinition.effects.WIS) statChanges.WIS = (statChanges.WIS || 0) + actionDefinition.effects.WIS;
                        if(actionDefinition.effects.CHA) statChanges.CHA = (statChanges.CHA || 0) + actionDefinition.effects.CHA;
                        if(actionDefinition.effects.LUCK) statChanges.LUCK = (statChanges.LUCK || 0) + actionDefinition.effects.LUCK;
                        if(actionDefinition.effects.MANA) manaChange += actionDefinition.effects.MANA;
                        if(actionDefinition.effects.HEAL_PERCENT) hpChange += Math.floor(player.maxHP * actionDefinition.effects.HEAL_PERCENT);
                    }
                    if (actionDefinition.hpGain) hpChange += actionDefinition.hpGain; 
                    
                    if (actionDefinition.grantsItemChance && Math.random() < actionDefinition.grantsItemChance && actionDefinition.itemPool) {
                        itemGained = actionDefinition.itemPool[Math.floor(Math.random() * actionDefinition.itemPool.length)];
                    }
                    if (actionDefinition.grantsItem) itemGained = actionDefinition.grantsItem;


                    switch (actionId) { 
                        case 'study':
                            statChanges.INT = (statChanges.INT || 0) + parseFloat(((Math.random() * 0.4) + 0.1).toFixed(1)); 
                            statChanges.WIS = (statChanges.WIS || 0) + parseFloat(((Math.random() * 0.4) + 0.1).toFixed(1));
                            xpGain += 3; 
                            resultText = `You spent time studying. (+${statChanges.INT} INT, +${statChanges.WIS} WIS)`;
                            break;
                        case 'train':
                            statChanges.STR = (statChanges.STR || 0) + parseFloat(((Math.random() * 0.3) + 0.1).toFixed(1)); 
                            statChanges.DEX = (statChanges.DEX || 0) + parseFloat(((Math.random() * 0.3) + 0.1).toFixed(1));
                            statChanges.CON = (statChanges.CON || 0) + parseFloat(((Math.random() * 0.3) + 0.1).toFixed(1));
                            hpChange -= Math.floor(Math.random() * 3) + 1; 
                            xpGain += 3; 
                            resultText = `You pushed your body. (+${statChanges.STR} STR, +${statChanges.DEX} DEX, +${statChanges.CON} CON)`;
                            break;
                        case 'socialize':
                            statChanges.CHA = parseFloat(((statChanges.CHA || 0) + (Math.floor(Math.random() * 3) + 1) / 10).toFixed(1)); 
                            xpGain += 2; 
                            resultText = `You spent time socializing. (+${statChanges.CHA} CHA)`;
                            
                            let targetCompanion = player.companions.find(c => c.type === "Romantic");
                            if (!targetCompanion && player.companions.length > 0) {
                                targetCompanion = player.companions.sort((a,b) => b.level - a.level)[0] || player.companions[0];
                            }

                            if (targetCompanion) {
                                relationshipLevelChange = Math.floor(Math.random() * 3) + 1; 
                                targetCompanion.level = Math.min(100, targetCompanion.level + relationshipLevelChange);
                                resultText += ` Your bond with <span class="${targetCompanion.type === 'Romantic' ? 'text-pink-300' : 'text-green-300'}">${targetCompanion.name}</span> (${targetCompanion.type}) grows. (+${relationshipLevelChange} Bond)`;
                            } else {
                                resultText += " You tried to be social, but didn't connect deeply with anyone specific this time.";
                            }
                            break;
                        case 'meditate':
                            manaChange += Math.floor(Math.random() * 8) + 3 + Math.floor((effectiveStats.WIS || 0) / 4); 
                            statChanges.WIS = (statChanges.WIS || 0) + parseFloat(((Math.random() * 0.2) + 0.1).toFixed(1)); 
                            xpGain += 2;
                            resultText = `You cleared your mind. (+${manaChange} Mana, +${statChanges.WIS} WIS)`;
                            break;
                        case 'adventure':
                            const adventureRoll = Math.random() * 100 + (effectiveStats.LUCK || 0); 
                            xpGain += 8; 
                            if (adventureRoll > 125) { 
                                resultText = "You stumbled upon a hidden treasure! Your luck truly shines.";
                                itemGained = ItemSystem.generateRandomItem("A"); 
                                accoladeGranted = "fortune_favorite";
                                isSignificantEvent = true;
                            } else if (adventureRoll > 85) {
                                resultText = "A rewarding adventure! You found some valuable trinkets and gained experience.";
                                xpGain += 8;
                                 if (Math.random() < 0.25) { 
                                    itemGained = ItemSystem.generateRandomItem("C"); 
                                }
                            } else if (adventureRoll > 45) {
                                resultText = "A decent adventure, nothing too exciting.";
                                 if (Math.random() < 0.15) { 
                                    itemGained = ItemSystem.generateRandomItem("D"); 
                                }
                            } else {
                                resultText = "Your adventure was fraught with minor mishaps. You narrowly escaped a trap.";
                                hpChange -= Math.floor(Math.random() * 12) + 3; 
                                xpGain = Math.max(0, xpGain - 6); 
                            }
                            break;
                        case 'seek_companion':
                            let existingRomanticPartners = player.companions.filter(c => c.type === "Romantic");
                            const availableNames = COMPANION_NAMES.filter(n => !player.companions.find(c => c.name === n));
                            let newCompanionName = availableNames.length > 0 ? availableNames[Math.floor(Math.random() * availableNames.length)] : "Someone New";
                            if (availableNames.length === 0 && COMPANION_NAMES.length > 0) newCompanionName = COMPANION_NAMES[Math.floor(Math.random() * COMPANION_NAMES.length)]; // Fallback if all unique names used but list not empty
                            
                            const seekRoll = Math.random() * 100 + (effectiveStats.CHA || 0) + (effectiveStats.LUCK || 0);
                            const newCompanionIsPolyamorous = Math.random() < POLYAMOROUS_CHANCE;


                            if (player.companions.length < MAX_COMPANIONS) {
                                if (existingRomanticPartners.length > 0) { 
                                    resultText = `You feel drawn to someone new, despite your relationship with ${existingRomanticPartners.map(p=>p.name).join(' & ')}... `;
                                    const primaryPartner = existingRomanticPartners.sort((a, b) => b.level - a.level)[0]; 
                                    
                                    const detectionChance = 0.4 - ((player.effectiveStats.LUCK || 0) * 0.01) - ((player.effectiveStats.CHA || 0) * 0.01); 
                                    if (Math.random() < detectionChance && primaryPartner) { 
                                        resultText += `<span class="text-red-400">${primaryPartner.name} discovered your wandering gaze!</span> `;
                                        
                                        const acceptanceRoll = Math.random() * 100 + (player.effectiveStats.CHA || 0) + primaryPartner.level / 2 + (primaryPartner.isPolyamorous ? 35 : 0); 
                                        
                                        if (primaryPartner.isPolyamorous && acceptanceRoll > 65) { 
                                            resultText += `After a surprisingly understanding conversation, ${primaryPartner.name} is open to you exploring other connections.`;
                                            primaryPartner.level = Math.max(20, primaryPartner.level - (Math.floor(Math.random()*10)+5)); 
                                            if (seekRoll > 50) { 
                                                player.companions.push({ id: Date.now() + Math.random(), name: newCompanionName, type: "Romantic", level: Math.floor(Math.random() * 11) + 10, metAtAge: player.age, isPolyamorous: newCompanionIsPolyamorous });
                                                resultText += ` You also managed to start a new romance with ${newCompanionName}.`;
                                                if (!player.accolades.includes("harem_initiate") && player.companions.filter(c => c.type === "Romantic").length >= 2) {
                                                    player.accolades.push("harem_initiate");
                                                    resultText += " (Accolade: Harem Initiate)";
                                                }
                                                if (player.companions.filter(c => c.type === "Romantic").length >= 3 && !player.accolades.includes("harem_master")) {
                                                    player.accolades.push("harem_master");
                                                    resultText += " You're becoming quite adept at this... (Accolade: Harem Master)";
                                                }
                                            } else {
                                                resultText += ` However, your attempt to woo ${newCompanionName} failed this time.`;
                                            }
                                        } else if (!primaryPartner.isPolyamorous && acceptanceRoll > 110) { 
                                             resultText += `After a very difficult and honest conversation, ${primaryPartner.name} has reluctantly agreed to an unconventional relationship. You feel a mix of relief and trepidation.`;
                                            primaryPartner.level = Math.max(20, primaryPartner.level - (Math.floor(Math.random()*15)+15)); 
                                            if (seekRoll > 60) { 
                                                player.companions.push({ id: Date.now() + Math.random(), name: newCompanionName, type: "Romantic", level: Math.floor(Math.random() * 11) + 10, metAtAge: player.age, isPolyamorous: newCompanionIsPolyamorous });
                                                resultText += ` You also managed to start a new romance with ${newCompanionName}.`;
                                                 if (!player.accolades.includes("harem_initiate") && player.companions.filter(c => c.type === "Romantic").length >= 2) {
                                                    player.accolades.push("harem_initiate");
                                                    resultText += " (Accolade: Harem Initiate)";
                                                }
                                            } else {
                                                resultText += ` However, your attempt to woo ${newCompanionName} failed.`;
                                            }
                                        }
                                        else { 
                                            resultText += `They are heartbroken and furious. Your relationship with ${primaryPartner.name} is in tatters!`;
                                            primaryPartner.level = Math.max(0, primaryPartner.level - (Math.floor(Math.random() * 41) + 30)); 
                                            if (primaryPartner.level < 10) {
                                                resultText += ` ${primaryPartner.name} couldn't forgive you and has left.`;
                                                player.companions = player.companions.filter(c => c.id !== primaryPartner.id);
                                            }
                                            if (!player.curses.includes("untrustworthy")) player.curses.push("untrustworthy");
                                            if (!player.curses.includes("heartbroken")) player.curses.push("heartbroken"); 
                                            resultText += " The ensuing drama scared off any new prospects.";
                                        }
                                    } else { 
                                        resultText += "You discreetly made a new connection. ";
                                        if (seekRoll > 70) { 
                                            player.companions.push({ id: Date.now() + Math.random(), name: newCompanionName, type: "Romantic", level: Math.floor(Math.random() * 16) + 10, metAtAge: player.age, isPolyamorous: newCompanionIsPolyamorous });
                                            resultText += `A new romance with <span class="font-bold text-pink-300">${newCompanionName}</span> begins!`;
                                             if (!player.accolades.includes("harem_initiate") && player.companions.filter(c => c.type === "Romantic").length >= 2) {
                                                player.accolades.push("harem_initiate");
                                                resultText += " (Accolade: Harem Initiate)";
                                            }
                                            if (player.companions.filter(c => c.type === "Romantic").length >= 3 && !player.accolades.includes("harem_master")) {
                                                player.accolades.push("harem_master");
                                                resultText += " You're becoming quite adept at this... (Accolade: Harem Master)";
                                            }
                                        } else {
                                            resultText += "But it didn't lead to anything serious.";
                                        }
                                    }
                                } else { // Seeking first companion or more friends
                                    if (player.age < MIN_ROMANCE_AGE) { 
                                        if (seekRoll > 50) { 
                                            player.companions.push({ id: Date.now() + Math.random(), name: newCompanionName, type: "Friend", level: Math.floor(Math.random() * 11) + 10, metAtAge: player.age, isPolyamorous: newCompanionIsPolyamorous }); 
                                            resultText = `You met <span class="font-bold text-green-300">${newCompanionName}</span> and quickly became friends!`;
                                        } else {
                                            resultText = "You spent some time trying to meet new people, but no strong connections were made.";
                                        }
                                    } else { 
                                        if (seekRoll > 100 && !player.companions.find(c => c.type === "Romantic")) { 
                                            player.companions.push({ id: Date.now() + Math.random(), name: newCompanionName, type: "Romantic", level: Math.floor(Math.random() * 16) + 15, metAtAge: player.age, isPolyamorous: newCompanionIsPolyamorous }); 
                                            resultText = `Sparks flew! You met <span class="font-bold text-pink-300">${newCompanionName}</span> and a romance has begun!`;
                                            accoladeGranted = "charmer";
                                        } else if (seekRoll > 60) { 
                                            player.companions.push({ id: Date.now() + Math.random(), name: newCompanionName, type: "Friend", level: Math.floor(Math.random() * 11) + 10, metAtAge: player.age, isPolyamorous: newCompanionIsPolyamorous }); 
                                            resultText = `You made a new friend, <span class="font-bold text-green-300">${newCompanionName}</span>.`;
                                        } else {
                                            resultText = "Your search for a companion yielded no results this time.";
                                        }
                                    }
                                }
                            } else {
                                resultText = "You feel your social circle is quite full for now.";
                            }
                            isSignificantEvent = true; 
                            break;
                        case 'confess_feelings':
                            const eligibleFriends = player.companions.filter(c => c.type === 'Friend' && player.age >= MIN_ROMANCE_AGE && c.level >= FRIENDSHIP_TO_ROMANCE_THRESHOLD);
                            const currentRomanticPartner = player.companions.find(c => c.type === "Romantic");

                            if (currentRomanticPartner) {
                                resultText = `You are already in a romantic relationship with ${currentRomanticPartner.name}. Confessing to someone else would be... complicated.`;
                            } else if (eligibleFriends.length > 0) {
                                const targetFriend = eligibleFriends.sort((a,b) => b.level - a.level)[0]; 
                                const confessRoll = Math.random() * 100 + (effectiveStats.CHA || 0) + targetFriend.level / 2 + (effectiveStats.LUCK || 0) / 2;
                                if (confessRoll > 100) { 
                                    targetFriend.type = "Romantic";
                                    targetFriend.level = Math.max(targetFriend.level, Math.floor(Math.random() * 21) + 40); 
                                    resultText = `Your heart pounded as you confessed to <span class="font-bold text-pink-300">${targetFriend.name}</span>... They feel the same way! Your friendship has blossomed into romance!`;
                                    accoladeGranted = "heart_desire";
                                } else if (confessRoll > 60) { 
                                    resultText = `<span class="font-bold text-green-300">${targetFriend.name}</span> values your friendship deeply but doesn't see you that way. Things are a little awkward, but your friendship remains.`;
                                    targetFriend.level = Math.max(20, targetFriend.level - Math.floor(Math.random()*10 + 5)); 
                                } else { 
                                    resultText = `It was a difficult conversation. <span class="font-bold text-green-300">${targetFriend.name}</span> doesn't share your romantic feelings. Your friendship feels strained.`;
                                    targetFriend.level = Math.max(0, targetFriend.level - Math.floor(Math.random()*20 + 15)); 
                                    if (targetFriend.level < 10) {
                                        resultText += ` It seems your friendship might not recover from this.`;
                                        player.companions = player.companions.filter(c => c.id !== targetFriend.id); 
                                    }
                                }
                            } else {
                                resultText = "There's no one suitable to confess to right now, or you're not old enough."; 
                            }
                            isSignificantEvent = true;
                            break;
                        case 'first_quest_pest':
                            const combatStat = player.effectiveStats[actionDefinition.combatCheck.stat.toUpperCase()] || 0;
                            if (combatStat + Math.floor(Math.random()*6)+1 > actionDefinition.combatCheck.difficulty) { 
                                resultText = actionDefinition.resultSuccess;
                                goldChange += actionDefinition.effects.GOLD;
                                xpGain += actionDefinition.effects.XP;
                            } else {
                                resultText = actionDefinition.resultFail;
                                hpChange -= Math.floor(Math.random() * (actionDefinition.hpCostFail[1] - actionDefinition.hpCostFail[0] + 1)) + actionDefinition.hpCostFail[0];
                            }
                            isSignificantEvent = true;
                            break;
                        case 'visit_shop':
                            UIManager.openShopModal();
                            eventInProgress = false; 
                            return; 
                        case 'visit_guild_hall':
                            UIManager.openGuildHallModal();
                            eventInProgress = false;
                            return;
                        case 'early_certification':
                            if ((player.effectiveStats.CHA || 0) + (player.effectiveStats.LUCK || 0) / 2 > (actionDefinition.chaCheck || 12) + Math.random() * 5) {
                                player.isCertifiedAdventurer = true;
                                if (!player.titles.includes("Provisional Adventurer")) player.titles.push("Provisional Adventurer");
                                resultText = actionDefinition.resultSuccess || "You managed to convince them! You are now a Provisional Adventurer!";
                                isSignificantEvent = true;
                            } else {
                                resultText = actionDefinition.resultFail || "They're not convinced. 'Maybe next year, kid.'";
                            }
                            break;
                         default:
                            if(actionDefinition.isWorldSpecific) {
                                if (actionDefinition.isBattle) {
                                    isBattle = true;
                                    const battleRoll = Math.random() * 100 + (effectiveStats.STR || 0) + (effectiveStats.DEX || 0) + (effectiveStats.CON || 0);
                                    const difficultyAdjustedRoll = battleRoll / actionDefinition.difficultyBonus;
                                    if (difficultyAdjustedRoll > 80) { 
                                        hpChange -= Math.floor(Math.random() * (actionDefinition.hpCostRange[1] / 2 - actionDefinition.hpCostRange[0] / 2) + actionDefinition.hpCostRange[0] / 2);
                                        resultText = actionDefinition.result.replace("{hpLost}", Math.abs(hpChange));
                                        if (actionDefinition.grantsTitle && Math.random() < actionDefinition.grantsTitle.chance) {
                                            titleGranted = actionDefinition.grantsTitle.name;
                                        }
                                        if (actionDefinition.unique) player.completedWorldEvents.push(actionId);
                                    } else { 
                                        hpChange -= Math.floor(Math.random() * (actionDefinition.hpCostRange[1] - actionDefinition.hpCostRange[0]) + actionDefinition.hpCostRange[0]);
                                        resultText = `You struggled during the ${actionDefinition.name}. It was a costly endeavor, losing ${Math.abs(hpChange)} HP. You might need to try again.`;
                                        if (isGameEnd) { 
                                            isGameEnd = false;
                                            resultText += " The objective was not fully achieved, but you live to fight another day.";
                                        }
                                        isSignificantEvent = true; 
                                    }
                                } else { 
                                     hpChange -= Math.floor(Math.random() * (actionDefinition.hpCostRange[1] - actionDefinition.hpCostRange[0]) + actionDefinition.hpCostRange[0]);
                                     resultText = actionDefinition.result.replace("{hpLost}", Math.abs(hpChange));
                                     if (actionDefinition.unique) player.completedWorldEvents.push(actionId);
                                }
                            }
                            break;
                    }
                    
                    if (actionDefinition.staminaCost) player.stamina = Math.max(0, player.stamina - actionDefinition.staminaCost);
                    if (actionDefinition.staminaGain) player.stamina = Math.min(player.maxStamina, player.stamina + actionDefinition.staminaGain);

                    GameManager.advanceDate(actionDefinition.timeCost);

                    player.currentHP = Math.max(0, Math.min(player.maxHP, player.currentHP + hpChange));
                    player.mana = Math.max(0, Math.min(player.maxMana, player.mana + manaChange));
                    player.gold += goldChange;

                    for (const statKey in statChanges) { 
                        const statName = statKey.toUpperCase();
                        let baseValue = parseFloat(player.baseStats[statName]);
                        if (isNaN(baseValue)) { 
                            baseValue = 0; 
                            player.baseStats[statName] = 0; 
                        }
                        
                        let change = parseFloat(statChanges[statKey]);
                        if (isNaN(change)) { 
                            change = 0; 
                        }

                        let newValue = baseValue + change;
                        if (isNaN(newValue)) { 
                            player.baseStats[statName] = baseValue; 
                        } else {
                            player.baseStats[statName] = parseFloat(newValue.toFixed(1));
                        }
                    }
                    
                    const currentRomanticPartnersAfterAction = player.companions.filter(c => c.type === "Romantic"); 
                    if (currentRomanticPartnersAfterAction.length > 0 && player.children.length < 3 ) {
                        currentRomanticPartnersAfterAction.forEach(partner => {
                             if (partner.level >= CHILD_BEARING_BOND_LEVEL && Math.random() < 0.02) { 
                                let newChildName = CHILD_NAMES[Math.floor(Math.random() * CHILD_NAMES.length)];
                                player.children.push(newChildName);
                                resultText += ` You and ${partner.name} had a child named <span class="font-bold text-green-300">${newChildName}</span>!`;
                                UIManager.logEvent(`A new child is born: ${newChildName}! (with ${partner.name})`);
                                isSignificantEvent = true; 
                             }
                        });
                    }
                    
                    const oldRank = player.rank;
                    player.rankXP += xpGain;
                    GameManager.checkRankUp();
                    if (player.rank !== oldRank) isSignificantEvent = true; 

                    if (accoladeGranted && !player.accolades.includes(accoladeGranted)) {
                        player.accolades.push(accoladeGranted);
                        resultText += ` You earned the Accolade: <span class="accolade-name">${gameData.accolades.find(a=>a.id === accoladeGranted)?.name || accoladeGranted}</span>!`;
                    }
                    if (titleGranted && !player.titles.includes(titleGranted)) {
                        player.titles.push(titleGranted);
                        resultText += ` You earned the Title: <span class="title-name">${titleGranted}</span>!`;
                        isSignificantEvent = true; 
                    }

                    if (itemGained) {
                        player.inventory.push(itemGained);
                        resultText += ` You found a <span class="item-name ${ITEM_RARITIES[itemGained.rarity]?.color || ''}">${itemGained.name}</span>! It has been added to your bag.`;
                        UIManager.logEvent(`Obtained item: ${itemGained.name} (${itemGained.rarity})`);
                        if (itemGained.significant || ["S", "SS", "SSS"].includes(itemGained.rarity)) isSignificantEvent = true; 
                    }
                    
                    if (player.currentHP <= 0) {
                        const deathMsg = resultText.includes("Lost {hpLost} HP") ? resultText.replace("{hpLost}", Math.abs(hpChange)) : resultText + ` You succumbed to your injuries.`;
                        GameManager.endGame(deathMsg);
                        return; 
                    }

                    if (isGameEnd) isSignificantEvent = true; 

                    UIManager.showEvent(actionId, resultText, isGameEnd, isSignificantEvent);

                } catch (error) {
                    console.error(`Error during performAction for '${actionId}':`, error, error.stack);
                    UIManager.logEvent(`SYSTEM ERROR performing action '${actionDefinition?.name || actionId}'. Please try another action. Error: ${error.message}`);
                    UIManager.showMessageModal("Critical Error", "An unexpected error occurred. The action could not be completed. Your game state might be unstable. Please try saving and reloading, or a different action.");
                    eventInProgress = false; 
                    UIManager.updateUI(); 
                }
            },
            dungeonExplore: function() {
                if (eventInProgress || gameEnded || !player.inDungeon) return;
                 if (player.stamina < (currentDungeon.staminaCostPerTurn || 10)) { 
                    UIManager.logEvent("You are too exhausted to explore deeper.");
                    UIManager.showMessageModal("Too Exhausted", "You need more stamina to continue exploring.");
                    return;
                }
                player.stamina -= (currentDungeon.staminaCostPerTurn || 10);

                player.inDungeon.turnsLeft--; 
                let resultText = "";
                let hpLost = 0;
                let xpGain = 0;
                let itemsFoundInDungeon = [];

                const effectiveStats = player.effectiveStats;
                const battleRoll = Math.random() * 100 + (effectiveStats.STR || 0) + (effectiveStats.DEX || 0) + (effectiveStats.CON || 0) + (effectiveStats.LUCK || 0);
                const difficultyAdjustedRoll = battleRoll / currentDungeon.difficultyBonus;

                if (difficultyAdjustedRoll > 70) { 
                    hpLost = Math.floor(Math.random() * (currentDungeon.hpCostRange[1] / 3 - currentDungeon.hpCostRange[0] / 3) + currentDungeon.hpCostRange[0] / 3);
                    xpGain = Math.floor(Math.random() * (currentDungeon.rankXP / 2));
                    resultText = `You successfully navigated a dangerous section. Lost ${hpLost} HP.`;
                    if (Math.random() < 0.3) itemsFoundInDungeon.push(MONSTER_MATERIALS[Math.floor(Math.random() * MONSTER_MATERIALS.length)]);
                    if (Math.random() < 0.1) itemsFoundInDungeon.push(ItemSystem.generateRandomItem("C"));
                } else if (difficultyAdjustedRoll > 30) { 
                    hpLost = Math.floor(Math.random() * (currentDungeon.hpCostRange[1] / 2 - currentDungeon.hpCostRange[0] / 2) + currentDungeon.hpCostRange[0] / 2);
                    xpGain = Math.floor(Math.random() * (currentDungeon.rankXP / 3));
                    resultText = `You encountered some resistance. Lost ${hpLost} HP.`;
                     if (Math.random() < 0.2) itemsFoundInDungeon.push(MONSTER_MATERIALS[Math.floor(Math.random() * MONSTER_MATERIALS.length)]);
                } else { 
                    hpLost = Math.floor(Math.random() * (currentDungeon.hpCostRange[1] - currentDungeon.hpCostRange[0]) + currentDungeon.hpCostRange[0]);
                    xpGain = Math.floor(Math.random() * (currentDungeon.rankXP / 4));
                    resultText = `A formidable foe appeared! You took heavy damage: ${hpLost} HP.`;
                }

                player.currentHP = Math.max(0, player.currentHP - hpLost);
                player.rankXP += xpGain;
                
                itemsFoundInDungeon.forEach(item => {
                    player.inventory.push(item);
                    resultText += ` Found <span class="item-name ${ITEM_RARITIES[item.rarity]?.color || ''}">${item.name}</span>!`;
                });


                const oldRank = player.rank;
                GameManager.checkRankUp();
                UIManager.logEvent(`Dungeon Explore: ${resultText} (+${xpGain} XP)`);
                if(player.rank !== oldRank) UIManager.showMessageModal("Rank Up!", `Congratulations! You've been promoted to ${player.rank} Rank!`);


                if (player.currentHP <= 0) {
                    const deathMsg = `Succumbed to wounds in ${currentDungeon.name}.`;
                    GameManager.endGame(deathMsg);
                    return;
                }
                if (player.inDungeon.turnsLeft <= 0) { this.finishDungeon(); }
                UIManager.updateUI();
                UIManager.updateDungeonStatus();
            },
            dungeonRest: function() {
                if (eventInProgress || gameEnded || !player.inDungeon) return;
                player.inDungeon.turnsLeft--;
                const hpHealed = Math.floor(Math.random() * 15) + 5 + Math.floor((player.effectiveStats.CON || 0) / 2); 
                const staminaGained = Math.floor(Math.random() * 10) + 10; 
                player.currentHP = Math.min(player.maxHP, player.currentHP + hpHealed);
                player.stamina = Math.min(player.maxStamina, player.stamina + staminaGained);
                UIManager.logEvent(`You rested, recovering ${hpHealed} HP and ${staminaGained} Stamina.`);
                if (player.inDungeon.turnsLeft <= 0) { this.finishDungeon(); }
                UIManager.updateUI();
                UIManager.updateDungeonStatus();
            },
            dungeonFlee: function() {
                if (eventInProgress || gameEnded || !player.inDungeon) return;
                const effectiveStats = player.effectiveStats;
                const fleeChance = ((effectiveStats.DEX || 0) + (effectiveStats.LUCK || 0)) / 2; 

                if (Math.random() * 100 < fleeChance) {
                    UIManager.logEvent(`You successfully fled from ${currentDungeon.name}.`);
                } else {
                    const hpLost = Math.floor(Math.random() * 20) + 10;
                    player.currentHP = Math.max(0, player.currentHP - hpLost);
                    UIManager.logEvent(`You failed to flee quickly and took ${hpLost} HP damage!`);
                    if (player.currentHP <= 0) {
                        const deathMsg = `Succumbed to wounds while fleeing from ${currentDungeon.name}.`;
                        GameManager.endGame(deathMsg);
                        return;
                    }
                }
                this.exitDungeon();
                UIManager.updateUI();
            },
            finishDungeon: function() {
                UIManager.logEvent(`You completed your exploration of ${currentDungeon.name}.`);
                const totalHPLost = player.inDungeon.initialHP - player.currentHP;
                let resultMessage = currentDungeon.result.replace("{hpLost}", totalHPLost);
                let isSignificantCompletion = currentDungeon.significantEvent || false;
                
                if (currentDungeon.grantsTitle && Math.random() < currentDungeon.grantsTitle.chance) {
                    if (!player.titles.includes(currentDungeon.grantsTitle.name)) {
                        player.titles.push(currentDungeon.grantsTitle.name);
                        resultMessage += ` You earned the Title: <span class="title-name">${currentDungeon.grantsTitle.name}</span>!`;
                        isSignificantCompletion = true;
                    }
                }
                if (currentDungeon.effects) {
                    let effectMessages = [];
                    for (const stat in currentDungeon.effects) {
                        player.baseStats[stat.toUpperCase()] = (player.baseStats[stat.toUpperCase()] || 0) + currentDungeon.effects[stat];
                        effectMessages.push(`+${currentDungeon.effects[stat]} ${stat.toUpperCase()}`);
                    }
                    resultMessage += ` Your stats improved: ${effectMessages.join(', ')}.`;
                }
                if (currentDungeon.grantsItem) { 
                    player.inventory.push(currentDungeon.grantsItem);
                    resultMessage += ` You found a <span class="item-name ${ITEM_RARITIES[currentDungeon.grantsItem.rarity]?.color || ''}">${currentDungeon.grantsItem.name}</span>!`;
                    UIManager.logEvent(`Obtained item from dungeon: ${currentDungeon.grantsItem.name}`);
                    if(currentDungeon.grantsItem.significant) isSignificantCompletion = true;
                } else { 
                     if (Math.random() < 0.25) { 
                        const randomItem = ItemSystem.generateRandomItem();
                        player.inventory.push(randomItem);
                        resultMessage += ` You also found a <span class="item-name ${ITEM_RARITIES[randomItem.rarity]?.color || ''}">${randomItem.name}</span>!`;
                        UIManager.logEvent(`Found random item in dungeon: ${randomItem.name}`);
                        if (["A", "S", "SS", "SSS"].includes(randomItem.rarity)) isSignificantCompletion = true;
                    }
                }

                if (currentDungeon.isGameEnd) {
                    UIManager.showEvent(currentDungeon.id, resultMessage, true, true); 
                } else {
                    UIManager.showEvent(currentDungeon.id, resultMessage, false, isSignificantCompletion);
                }
                this.exitDungeon();
            },
            exitDungeon: function() {
                player.inDungeon = null;
                currentDungeon = null;
                dungeonInterface.classList.add('hidden');
                worldActionsContainer.classList.remove('hidden');
            },
            checkElementalSpiritEncounter: function() {
                if (player.bondedSpirit || eventInProgress) return; 
                const baseChance = 0.03; 
                const luckBonus = (player.effectiveStats.LUCK || 0) * 0.005; 
                const encounterChance = baseChance + luckBonus;

                if (Math.random() < encounterChance) {
                    const availableSpirits = gameData.elementalSpirits.filter(s => s.id !== (player.bondedSpirit ? player.bondedSpirit.id : null));
                    if (availableSpirits.length > 0) {
                        currentSpiritEncounter = availableSpirits[Math.floor(Math.random() * availableSpirits.length)];
                        eventInProgress = true; 
                        spiritModalTitleElem.textContent = `A Wild ${currentSpiritEncounter.type} Appears!`;
                        spiritModalMessageElem.innerHTML = `You sense a powerful presence... A <span class="font-bold text-purple-300">${currentSpiritEncounter.name}</span>, ${currentSpiritEncounter.description.toLowerCase()}, has appeared before you! Do you wish to attempt to bond with it?`;
                        elementalSpiritModal.classList.remove('hidden');
                    }
                }
            },
            attemptBondSpirit: function() {
                if (!currentSpiritEncounter) return;
                elementalSpiritModal.classList.add('hidden');
                const bondSuccessChance = 0.45 + ((player.effectiveStats.CHA || 0) * 0.01) + ((player.effectiveStats.LUCK || 0) * 0.005); 
                
                if (Math.random() < bondSuccessChance) {
                    player.bondedSpirit = { id: currentSpiritEncounter.id, bondLevel: 1 };
                    UIManager.logEvent(`You successfully bonded with the <span class="font-bold text-cyan-300">${currentSpiritEncounter.name}</span>! It grants you initial boosts.`);
                    UIManager.showMessageModal("Bond Successful!", `The ${currentSpiritEncounter.name} has chosen to bond with you! You feel a new power within you.`);
                } else {
                    let penaltyText = "";
                    if (Math.random() < 0.3) { 
                        const hpPenalty = Math.floor(Math.random() * 10) + 5;
                        player.currentHP = Math.max(0, player.currentHP - hpPenalty);
                        penaltyText = `It lashes out as it departs, costing you ${hpPenalty} HP!`;
                    }
                    UIManager.logEvent(`The <span class="font-bold text-cyan-300">${currentSpiritEncounter.name}</span> resists your attempt and flees. ${penaltyText}`);
                    UIManager.showMessageModal("Bond Failed", `The ${currentSpiritEncounter.name} was not receptive to your attempt to bond and flew away. ${penaltyText}`);
                }
                currentSpiritEncounter = null;
                eventInProgress = false; 
                UIManager.updateUI();
            },
            declineBondSpirit: function() {
                elementalSpiritModal.classList.add('hidden');
                UIManager.logEvent(`You decided not to bond with the <span class="font-bold text-cyan-300">${currentSpiritEncounter.name}</span>. It departs peacefully.`);
                UIManager.showMessageModal("Spirit Departed", `You decided not to bond with the ${currentSpiritEncounter.name}. It leaves without incident.`);
                currentSpiritEncounter = null;
                eventInProgress = false; 
                UIManager.updateUI();
            },
            equipItem: function(itemIndexInInventory) {
                const itemToEquip = player.inventory[itemIndexInInventory];
                if (!itemToEquip || !itemToEquip.type || itemToEquip.type === 'consumable' || itemToEquip.type === 'material') return; 

                const itemTypeSlot = itemToEquip.slot || itemToEquip.type.toLowerCase(); 
                let successMessage = "";

                if (player.equipment.hasOwnProperty(itemTypeSlot)) {
                    if (player.equipment[itemTypeSlot]) {
                        const currentlyEquipped = player.equipment[itemTypeSlot];
                        player.inventory.push(currentlyEquipped); 
                        successMessage = `You unequipped <span class="item-name ${ITEM_RARITIES[currentlyEquipped.rarity]?.color || ''}">${currentlyEquipped.name}</span> and equipped <span class="item-name ${ITEM_RARITIES[itemToEquip.rarity]?.color || ''}">${itemToEquip.name}</span>.`;
                    } else {
                        successMessage = `You equipped the <span class="item-name ${ITEM_RARITIES[itemToEquip.rarity]?.color || ''}">${itemToEquip.name}</span>.`;
                    }
                    player.equipment[itemTypeSlot] = itemToEquip; 
                    player.inventory.splice(itemIndexInInventory, 1); 
                } else {
                    successMessage = `Cannot equip <span class="item-name">${itemToEquip.name}</span>: Unknown equipment slot type '${itemTypeSlot}'.`;
                    UIManager.logEvent(`Error: Unknown equipment slot type '${itemTypeSlot}' for item ${itemToEquip.name}.`);
                    UIManager.showMessageModal("Equipment Error", successMessage); 
                    return; 
                }

                UIManager.logEvent(successMessage.replace(/<[^>]*>?/gm, '')); 
                UIManager.showMessageModal("Equipment Changed", successMessage); 
                UIManager.updateUI(); 
                UIManager.openItemBag(); 
            },
            useConsumableItem: function(itemIndexInInventory) {
                const itemToUse = player.inventory[itemIndexInInventory];
                if (!itemToUse || itemToUse.type !== 'consumable' || !itemToUse.effect) return;

                let effectApplied = false;
                let effectMessage = "";

                if (itemToUse.effect.heal) {
                    const healedAmount = Math.min(player.maxHP - player.currentHP, itemToUse.effect.heal);
                    if (healedAmount > 0) {
                        player.currentHP += healedAmount;
                        effectMessage = `You used ${itemToUse.name} and recovered ${healedAmount} HP.`;
                        effectApplied = true;
                    } else {
                        effectMessage = `${itemToUse.name} had no effect, your HP is already full.`;
                    }
                } else if (itemToUse.effect.mana) {
                     const restoredAmount = Math.min(player.maxMana - player.mana, itemToUse.effect.mana);
                    if (restoredAmount > 0) {
                        player.mana += restoredAmount;
                        effectMessage = `You used ${itemToUse.name} and restored ${restoredAmount} Mana.`;
                        effectApplied = true;
                    } else {
                        effectMessage = `${itemToUse.name} had no effect, your Mana is already full.`;
                    }
                }

                if (effectApplied) {
                    player.inventory.splice(itemIndexInInventory, 1); 
                }
                
                UIManager.logEvent(effectMessage);
                if (effectApplied) UIManager.showMessageModal("Item Used", effectMessage); 
                UIManager.updateUI();
                UIManager.openItemBag(); 
            },
            buyShopItem: function(itemToBuy) { 
                if (!itemToBuy) return;

                if (player.gold >= itemToBuy.cost) {
                    player.gold -= itemToBuy.cost;
                    player.inventory.push({...itemToBuy}); 
                    UIManager.logEvent(`You purchased ${itemToBuy.name} for ${itemToBuy.cost}G.`);
                    UIManager.showMessageModal("Purchase Successful", `You bought ${itemToBuy.name}!`);
                    UIManager.populateShopBuyList(); 
                    shopPlayerGoldElem.textContent = player.gold; 
                    UIManager.updateCharacterSheet(); 
                } else {
                    UIManager.logEvent(`Not enough gold to buy ${itemToBuy.name}.`);
                    UIManager.showMessageModal("Insufficient Gold", `You don't have enough gold for ${itemToBuy.name}.`);
                }
            },
            sellPlayerItem: function(itemIndex) {
                const itemToSell = player.inventory[itemIndex];
                if (!itemToSell) return;

                const sellPrice = itemToSell.sellPrice || Math.max(1, Math.floor((itemToSell.cost || itemToSell.baseSellValue || 0) * 0.3));
                player.gold += sellPrice;
                const soldItemName = itemToSell.name;
                player.inventory.splice(itemIndex, 1);

                UIManager.logEvent(`You sold ${soldItemName} for ${sellPrice}G.`);
                UIManager.showMessageModal("Item Sold", `You received ${sellPrice}G for ${soldItemName}.`);
                
                if (buyTab.classList.contains('active')) {
                    UIManager.populateShopBuyList(); 
                } else {
                    UIManager.populateShopSellList();
                }
                shopPlayerGoldElem.textContent = player.gold; 
                UIManager.updateCharacterSheet(); 
            },
            partWaysWithFriend: function(companionId) {
                const companionIndex = player.companions.findIndex(c => c.id.toString() === companionId.toString() && c.type === "Friend");
                if (companionIndex > -1) {
                    const partedFriend = player.companions.splice(companionIndex, 1)[0];
                    UIManager.logEvent(`You decided to part ways with ${partedFriend.name}. It was an amicable separation.`);
                    UIManager.showMessageModal("Friendship Ended", `You are no longer friends with ${partedFriend.name}.`);
                    UIManager.closeManageCompanionsModal();
                    UIManager.updateUI();
                }
            },
            acceptGuildQuest: function(questId) {
                if (player.activeGuildQuest) {
                    UIManager.showMessageModal("Quest Active", "You already have an active guild quest. Complete or abandon it first.");
                    return;
                }
                const quest = gameData.guildQuests.find(q => q.id === questId);
                if (quest) {
                    player.activeGuildQuest = {...quest, progress: 0, turnsLeft: quest.timeCost}; 
                    UIManager.logEvent(`You accepted the quest: ${quest.title}.`);
                    UIManager.showMessageModal("Quest Accepted!", `You've taken on the quest: "${quest.title}".`);
                    UIManager.closeGuildHallModal(); 
                    UIManager.updateUI();
                }
            },
            completeGuildQuest: function() {
                if (!player.activeGuildQuest) return;

                const quest = player.activeGuildQuest;
                let success = false;
                let resultText = `Attempting to complete quest: ${quest.title}. `;

                if (quest.difficultyCheck) {
                    const checkStatValue = player.effectiveStats[quest.difficultyCheck.stat.toUpperCase()] || 0;
                    if (checkStatValue >= quest.difficultyCheck.value) {
                        success = true;
                    }
                } else { 
                    success = true;
                }

                if (success) {
                    resultText += `Success! You completed the quest.`;
                    player.gold += quest.rewards.gold;
                    player.rankXP += quest.rewards.xp;
                    resultText += ` Rewards: ${quest.rewards.gold}G, ${quest.rewards.xp}XP.`;
                    if (quest.rewards.items) {
                        quest.rewards.items.forEach(itemReward => {
                            if (Math.random() < (itemReward.chance || 1)) {
                                const foundItem = MONSTER_MATERIALS.find(m => m.name === itemReward.name) || ItemSystem.generateRandomItem(itemReward.rarity || "D");
                                player.inventory.push({...foundItem});
                                resultText += ` Found ${foundItem.name}!`;
                            }
                        });
                    }
                    UIManager.logEvent(resultText);
                    UIManager.showMessageModal("Quest Complete!", resultText);
                } else {
                    resultText += `Failed. You couldn't complete the quest requirements.`;
                    UIManager.logEvent(resultText);
                    UIManager.showMessageModal("Quest Failed", resultText);
                }
                player.activeGuildQuest = null;
                UIManager.updateUI();
            }
        };
        window.ActionHandler = ActionHandler; 

        // --- ItemSystem Module ---
        const ItemSystem = {
            generateRandomItem: function(forcedRarityKey = null, itemBase = null) {
                let rarityKey = forcedRarityKey;
                if (!rarityKey) {
                    const totalWeight = Object.values(ITEM_RARITIES).reduce((sum, r) => sum + r.chanceWeight, 0);
                    let roll = Math.random() * totalWeight;
                    for (const key in ITEM_RARITIES) {
                        if (roll < ITEM_RARITIES[key].chanceWeight) {
                            rarityKey = key;
                            break;
                        }
                        roll -= ITEM_RARITIES[key].chanceWeight;
                    }
                    if (!rarityKey) rarityKey = "D"; 
                }

                const rarity = ITEM_RARITIES[rarityKey];
                const base = itemBase || ITEM_BASE_TYPES[Math.floor(Math.random() * ITEM_BASE_TYPES.length)];
                
                const newItem = {
                    id: Date.now() + Math.random().toString(36).substring(2, 15), 
                    name: `${rarity.name} ${base.name}`,
                    type: base.type,
                    slot: base.slot,
                    stats: {},
                    rarity: rarityKey, 
                    color: rarity.color,
                    cost: 0, 
                    sellPrice: 0, 
                    description: `A ${rarity.name.toLowerCase()} ${base.name.toLowerCase()}.`
                };

                const numStatsToGrant = Math.floor(Math.random() * rarity.maxStatTypes) + 1;
                const availableStats = [...(base.possibleStats || POSSIBLE_ITEM_STATS)]; 
                
                for (let i = 0; i < numStatsToGrant && availableStats.length > 0; i++) {
                    const statIndex = Math.floor(Math.random() * availableStats.length);
                    const statKey = availableStats.splice(statIndex, 1)[0];
                    
                    const basePoints = Math.floor(Math.random() * rarity.maxBasePointsPerStat) + 1;
                    newItem.stats[statKey] = Math.max(1, Math.floor(basePoints * rarity.statPointsMultiplier));
                }

                let totalStatValue = Object.values(newItem.stats).reduce((sum, val) => sum + val, 0);
                newItem.cost = Math.floor(base.baseCost * rarity.costMultiplier + totalStatValue * 5 * rarity.costMultiplier); 
                newItem.sellPrice = Math.max(1, Math.floor(newItem.cost * 0.3)); 

                return newItem;
            }
        };
        window.ItemSystem = ItemSystem; 


        // --- Event Listeners ---
        advanceYearButtonUI.addEventListener('click', () => GameManager.advanceYear());
        saveGameButtonUI.addEventListener('click', () => {
            UIManager.logEvent("Game saved!"); 
            GameManager.save();
            UIManager.showMessageModal("Game Saved", "Your progress has been saved to your browser."); 
        });
        modalCloseButton.addEventListener('click', () => messageModal.classList.add('hidden'));
        dungeonExploreButton.addEventListener('click', () => ActionHandler.dungeonExplore());
        dungeonRestButton.addEventListener('click', () => ActionHandler.dungeonRest());
        dungeonFleeButton.addEventListener('click', () => ActionHandler.dungeonFlee());
        bondSpiritButton.addEventListener('click', () => ActionHandler.attemptBondSpirit());
        declineSpiritButton.addEventListener('click', () => ActionHandler.declineBondSpirit());
        itemBagButtonUI.addEventListener('click', () => UIManager.openItemBag());
        closeItemBagButton.addEventListener('click', () => UIManager.closeItemBag());
        
        buyTab.addEventListener('click', () => UIManager.switchShopTab('buy'));
        sellTab.addEventListener('click', () => UIManager.switchShopTab('sell'));
        closeShopButton.addEventListener('click', () => UIManager.closeShopModal());
        manageCompanionsButtonUI.addEventListener('click', () => UIManager.openManageCompanionsModal());
        closeManageCompanionsButton.addEventListener('click', () => UIManager.closeManageCompanionsModal());
        viewPastDeathsButtonUI.addEventListener('click', () => UIManager.openDeathMessagesModal());
        closeDeathMessagesButton.addEventListener('click', () => UIManager.closeDeathMessagesModal());
        newGameFromDeathButton.addEventListener('click', () => {
            GameManager.startNewGame(); 
        });
        closeGuildHallButton.addEventListener('click', () => UIManager.closeGuildHallModal());
        completeGuildQuestButton.addEventListener('click', () => ActionHandler.completeGuildQuest());


        // Initial game setup
        GameManager.init();
    }); 
    </script>
</body>
</html>
